<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>단어 맞추기</title>
    <style>
        #feedback-icon {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            font-weight: bold;
            display: none;
            z-index: 100;
        }

        .correct { color: green; }
        .incorrect { color: red; }

        #answer {
            font-size: 18px;
            padding: 8px;
            width: 300px;
            margin-bottom: 10px;
        }

        button {
            font-size: 16px;
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }

        #result {
            font-size: 18px;
            margin-top: 15px;
        }

        #completion-message {
            font-size: 22px;
            font-weight: bold;
            color: #1e90ff;
            margin-top: 120px;
            text-align: center;
        }

        #bottom-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
    </style>

    <script th:inline="javascript">
        let problems = /*[[${problems}]]*/ [];
        let answered = false;

        window.onload = function () {
            if (problems.length > 0) {
                showProblem(problems[0]);
            } else {
                document.getElementById('description').textContent = "";
                document.getElementById('completion-message').textContent = "더 이상 풀 문제는 없습니다.";
            }
        };

        function showProblem(problem) {
            document.getElementById('description').textContent = problem.description;
            document.getElementById('answer').value = "";
            document.getElementById('result').textContent = "";
            document.getElementById('feedback-icon').style.display = 'none';
            answered = false;
        }

        function submitAnswer() {
            if (answered) return;

            const problem = problems[0];
            const userAnswer = document.getElementById('answer').value.trim();
            const correctAnswer = problem.vocabulary;
            const vocaId = problem.vocaId;
            const isCorrect = userAnswer === correctAnswer;

            // 정답 피드백 표시
            document.getElementById('result').textContent = isCorrect
                ? `정답! (${correctAnswer})`
                : `오답! 정답은 ${correctAnswer}`;
            showFeedback(isCorrect);

            // 정답 체크 API 호출 (오답노트 저장 + 로그 기록)
            fetch('/study/lesson1/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    vocaId: vocaId,
                    answer: userAnswer,
                    correctAnswer: correctAnswer
                })
            })
            .then(res => res.json())
            .then(result => console.log("정답 여부:", result))
            .catch(err => console.error("정답 체크 오류:", err));

            answered = true;
        }

        function showFeedback(isCorrect) {
            const icon = document.getElementById('feedback-icon');
            icon.textContent = isCorrect ? 'O' : 'X';
            icon.className = isCorrect ? 'correct' : 'incorrect';
            icon.style.display = 'block';
        }

        function nextProblem() {
            if (!answered) {
                alert("먼저 정답을 제출하세요.");
                return;
            }
            location.reload(); // 새로운 문제 받기
        }

        function quitLesson() {
            if (window.opener) {
                window.close();
            } else {
                alert("이 창은 브라우저에서 직접 열렸기 때문에 자동으로 닫을 수 없습니다.");
            }
        }
    </script>
</head>
<body>
<h1>단어 맞추기 학습</h1>

<p id="description"></p>
<input type="text" id="answer" placeholder="정답 입력">
<br>
<button onclick="submitAnswer()">제출</button>
<button onclick="nextProblem()">다음으로</button>

<p id="result"></p>
<p id="completion-message"></p>
<div id="feedback-icon"></div>

<!-- ✅ 하단 고정 그만하기 버튼 -->
<div id="bottom-buttons">
    <button onclick="quitLesson()">그만하기</button>
</div>
</body>
</html>
