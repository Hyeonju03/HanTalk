<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>단어 맞추기</title>
    <script th:inline="javascript">
        let problems = /*[[${problems}]]*/ || [];
        let currentIndex = 0;
        let answered = false; // 제출 여부 체크

        window.onload = function() {
            showProblem(currentIndex);
        };

        // 문제 표시
        function showProblem(index) {
            const problem = problems[index];
            document.getElementById('description').textContent = problem.description;
            document.getElementById('answer').value = "";
            document.getElementById('result').textContent = "";
            answered = false;
        }

        // 정답 확인 및 오답노트 처리
        function submitAnswer() {
            if (answered) return; // 이미 제출했으면 중복 방지

            const problem = problems[currentIndex];
            const userAnswer = document.getElementById('answer').value.trim();
            const correctAnswer = problem.vocabulary;
            const targetId = problem.vocaId;

            // 결과 표시
            if (userAnswer === correctAnswer) {
                document.getElementById('result').textContent = `정답! (${correctAnswer})`;
            } else {
                document.getElementById('result').textContent = `오답! 정답은 ${correctAnswer}`;
            }

            // 서버에 오답노트 처리 요청
            fetch('/study/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    type: 'word',             // lesson1은 단어
                    targetId: targetId,
                    answer: userAnswer,
                    correctAnswer: correctAnswer
                })
            })
            .then(res => res.json())
            .then(isCorrect => {
                console.log("정답 여부:", isCorrect);
            })
            .catch(err => console.error("오답노트 처리 오류:", err));

            answered = true; // 제출 완료 상태로 변경
        }

        // 다음 문제로 이동
        function nextProblem() {
            if (!answered) {
                alert("먼저 정답을 제출하세요.");
                return;
            }

            if (currentIndex < problems.length - 1) {
                currentIndex++;
                showProblem(currentIndex);
            } else {
                showCompletionPage();
            }
        }

        // 학습 완료 화면
        function showCompletionPage() {
            document.body.innerHTML = `
                <h1>학습 완료!</h1>
                <p>오답노트에서 틀린 단어를 복습해보세요.</p>
                <div style="position: fixed; bottom: 20px; right: 20px;">
                    <button onclick="goToLesson3()">다음 학습으로 이동</button>
                </div>
            `;

            // 학습 로그 저장
            fetch('/study/complete1', { method: 'POST' })
                .then(res => res.text())
                .then(result => {
                    if (result === 'success') {
                        console.log("학습 로그 저장 성공");
                    } else {
                        console.log("학습 로그 저장 실패");
                    }
                });
        }

        function goToLesson3() {
            window.location.href = '/study/lesson3';
        }
    </script>
</head>
<body>
<h1>단어 맞추기 학습</h1>

<p id="description"></p>
<input type="text" id="answer" placeholder="정답 입력">
<button type="button" onclick="submitAnswer()">제출</button>
<button type="button" id="nextBtn" onclick="nextProblem()">다음으로</button>
<p id="result"></p>
</body>
</html>
