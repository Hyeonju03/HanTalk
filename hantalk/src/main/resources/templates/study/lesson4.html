<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°›ì•„ì“°ê¸°</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for Nanum Gothic -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
    body {
      font-family: 'Nanum Gothic', sans-serif;
    }

    /* Custom animations for feedback icon */
    @keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
    }
    .animate-pulse {
        animation: pulse 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translate(-50%, -50%) translateY(0); opacity: 0.8; }
        40% { transform: translate(-50%, -50%) translateY(-10px); }
        60% { transform: translate(-50%, -50%) translateY(-5px); }
    }
    .animate-bounce {
        animation: bounce 1s infinite;
    }

    /* Custom animation for message box */
    @keyframes fadeOut {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    }
  </style>
</head>
<body class="bg-[#FBF9F2] min-h-screen flex flex-col items-center p-4">

<h1 class="text-4xl font-extrabold text-[#2F4160] mb-8 mt-12">ğŸ‘‚ ë°›ì•„ì“°ê¸° í•™ìŠµ</h1>

<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg flex flex-col items-center space-y-6">

  <div id="question-container" class="flex flex-col items-center space-y-4 w-full">
    <p id="sentence" class="text-xl text-[#2F4160] font-semibold text-center leading-relaxed">ë¬¸ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <button id="play-btn" style="display: none;"
            class="bg-[#F29DA0] text-white text-3xl p-4 rounded-full shadow-lg hover:bg-[#2F4160] transition duration-300 transform hover:scale-110">
      â–¶ï¸
    </button>
  </div>

  <!-- ì˜¤ë‹µ ì‹œ ì •ë‹µ í‘œì‹œ ì˜ì—­ -->
  <div id="correct-answer-box" class="hidden text-center mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200">
    <p class="text-lg text-gray-700 font-medium">ì •ë‹µ: <span id="correct-answer-text" class="font-bold text-[#2F4160]"></span></p>
  </div>

  <div id="answer-input" class="flex flex-col items-center space-y-4 w-full">
    <input type="text" id="user-answer" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”"
           class="border-2 border-[#B5D0E3] rounded-lg px-4 py-3 w-full text-lg focus:outline-none focus:ring-4 focus:ring-[#F29DA0] transition duration-300 placeholder-gray-400">
    <button id="submit-btn"
            class="bg-[#F29DA0] text-white px-8 py-3 rounded-xl font-bold text-lg hover:bg-[#2F4160] transition duration-300 transform hover:scale-105 shadow-md">
      ì œì¶œí•˜ê¸°
    </button>
  </div>

  <!-- ê²°ê³¼ ë©”ì‹œì§€ ë° ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ -->
  <div class="flex flex-col items-center space-y-4 mt-6 w-full">
    <button id="next-btn" style="display: none;"
            class="bg-[#B5D0E3] text-[#2F4160] px-8 py-3 rounded-xl font-bold text-lg hover:bg-[#2F4160] hover:text-white transition duration-300 transform hover:scale-105 shadow-md">
      ë‹¤ìŒ ë¬¸ì œ
    </button>
  </div>

</div>

<!-- í”¼ë“œë°± ì•„ì´ì½˜ (O/X) -->
<div id="result-overlay" class="hidden text-9xl font-bold fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-80 z-10">
  <span id="result-text"></span>
</div>

<!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
<div class="fixed bottom-6 right-6">
  <button onclick="quitLesson()"
          class="bg-gray-500 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-gray-700 transition duration-300 transform hover:scale-105 shadow-lg">
    ê·¸ë§Œí•˜ê¸°
  </button>
</div>

<script>
  let currentSentence = '';
  // Web Speech APIì˜ SpeechSynthesis ê°ì²´ ìƒì„±
  const synth = window.speechSynthesis;

  // Custom message box function
  function showCustomMessage(message, type = 'info') {
      const messageBox = document.createElement('div');
      messageBox.textContent = message;
      let bgColor = '#2F4160'; // Default: Dark Navy
      let textColor = 'white';

      if (type === 'error') {
          bgColor = '#F29DA0'; // Coral Pink for errors
      }

      messageBox.style.cssText = `
          position: fixed;
          top: 20%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: ${bgColor};
          color: ${textColor};
          padding: 15px 30px;
          border-radius: 8px;
          z-index: 1000;
          font-size: 1.1em;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          animation: fadeOut 3s forwards;
      `;
      document.body.appendChild(messageBox);

      // Ensure the fadeOut keyframes are available
      if (!document.querySelector('style#fadeOutKeyframes')) {
          const styleSheet = document.createElement("style");
          styleSheet.id = "fadeOutKeyframes"; // Add an ID to prevent duplicates
          styleSheet.type = "text/css";
          styleSheet.innerText = `
              @keyframes fadeOut {
                  0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                  100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
              }
          `;
          document.head.appendChild(styleSheet);
      }

      setTimeout(() => {
          messageBox.remove();
          // Do not remove styleSheet, as it might be used by other messages
      }, 3000);
  }

  function quitLesson() {
      if (window.opener) {
          window.close();
      } else {
          showCustomMessage("ì´ ì°½ì€ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì—´ë ¸ê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ë‹«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'info');
      }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ, ë˜ëŠ” 'ë‹¤ìŒ ë¬¸ì œ' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜
  function fetchAndDisplaySentence() {
      document.getElementById('sentence').textContent = 'ë¬¸ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      document.getElementById('user-answer').value = '';
      document.getElementById('result-overlay').classList.add('hidden'); // Tailwind hidden class
      document.getElementById('next-btn').style.display = 'none';
      document.getElementById('play-btn').style.display = 'none';
      document.getElementById('correct-answer-box').classList.add('hidden'); // ì •ë‹µ ë°•ìŠ¤ ìˆ¨ê¹€

      fetch(`${window.location.origin}/study/api/get-lesson4-sentence`) // RequestMapping("/study")ë¥¼ ê³ ë ¤í•˜ì—¬ ê²½ë¡œ ìˆ˜ì •
      .then(response => {
          if (!response.ok) {
              throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.statusText);
          }
          return response.json();
      })
      .then(data => {
          if (data && data.sentence) {
              currentSentence = data.sentence;
              document.getElementById('sentence').textContent = "ë¬¸ì¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.";
              document.getElementById('play-btn').style.display = 'inline-block';
          } else {
              showCustomMessage('ë” ì´ìƒ í’€ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë¬¸ì œë¥¼ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆì–´ìš”!', 'info');
              document.getElementById('sentence').textContent = ''; // ë¬¸ì¥ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
              document.getElementById('play-btn').style.display = 'none'; // ì¬ìƒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
              document.getElementById('submit-btn').style.display = 'none'; // ì œì¶œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
              document.getElementById('user-answer').style.display = 'none'; // ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
          }
      })
      .catch(error => {
          console.error('ë¬¸ì¥ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          showCustomMessage('ë¬¸ì¥ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          document.getElementById('sentence').textContent = 'ë¬¸ì¥ ë¡œë“œ ì‹¤íŒ¨';
      });
  }

  // í…ìŠ¤íŠ¸ë¥¼ ìŒì„±ìœ¼ë¡œ ì½ì–´ì£¼ëŠ” í•¨ìˆ˜
  function speakText(text) {
      if (synth.speaking) {
          console.error('í˜„ì¬ ë‹¤ë¥¸ ìŒì„± ì¬ìƒ ì¤‘ì…ë‹ˆë‹¤.');
          return;
      }
      if (text !== '') {
          const utterThis = new SpeechSynthesisUtterance(text);

          utterThis.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •

          utterThis.onend = function(event) {
              console.log('ìŒì„± ì¬ìƒì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          };

          utterThis.onerror = function(event) {
              console.error('ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + event.error);
              showCustomMessage('ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
          };

          synth.speak(utterThis);
      }
  }

  // ì¬ìƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.getElementById('play-btn').addEventListener('click', function() {
      if (currentSentence) {
          speakText(currentSentence);
      }
  });

  document.getElementById('submit-btn').addEventListener('click', function() {
      const userAnswer = document.getElementById('user-answer').value.trim(); // ê³µë°± ì œê±°

      if (!userAnswer) {
          showCustomMessage("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error');
          return;
      }

      fetch(`${window.location.origin}/study/api/check-lesson4-answer`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              originalSentence: currentSentence,
              userAnswer: userAnswer
          })
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.statusText);
          }
          return response.json();
      })
      .then(data => {
          const resultOverlay = document.getElementById('result-overlay');
          const resultText = document.getElementById('result-text');

          if (data.isCorrect) {
              resultText.textContent = 'âœ”ï¸'; // ì´ëª¨ì§€ ì•„ì´ì½˜
              resultOverlay.className = 'text-[#2F4160] text-9xl font-bold fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-80 animate-pulse';
              resultOverlay.classList.remove('hidden');
              document.getElementById('correct-answer-box').classList.add('hidden'); // ì •ë‹µì´ë©´ ë°•ìŠ¤ ìˆ¨ê¹€
          } else {
              resultText.textContent = 'âœ–ï¸'; // ì´ëª¨ì§€ ì•„ì´ì½˜
              resultOverlay.className = 'text-[#F29DA0] text-9xl font-bold fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-80 animate-bounce';
              resultOverlay.classList.remove('hidden');
              // ì˜¤ë‹µì¼ ê²½ìš° ì •ë‹µ ë¬¸ì¥ í‘œì‹œ
              document.getElementById('correct-answer-box').classList.remove('hidden');
              document.getElementById('correct-answer-text').textContent = currentSentence;
          }

          document.getElementById('next-btn').style.display = 'block'; // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ í‘œì‹œ

          // í”¼ë“œë°± ì•„ì´ì½˜ 1.5ì´ˆ í›„ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
              resultOverlay.classList.add('hidden');
          }, 1500);
      })
      .catch(error => {
          console.error('ë‹µë³€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          showCustomMessage('ë‹µë³€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      });
  });

  document.getElementById('next-btn').addEventListener('click', function() {
      fetchAndDisplaySentence();
  });

  window.onload = function() {
      // ë¸Œë¼ìš°ì €ê°€ Web Speech APIë¥¼ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
      if ('speechSynthesis' in window) {
          fetchAndDisplaySentence();
      } else {
          showCustomMessage('ì´ ë¸Œë¼ìš°ì €ëŠ” í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.', 'error');
      }
  };
</script>

</body>
</html>
