<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°›ì•„ì“°ê¸°</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for Nanum Gothic -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
    body {
      font-family: 'Nanum Gothic', sans-serif;
    }

    /* Custom animations for feedback icon */
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.1); opacity: 1; }
    }
    .animate-pulse {
        animation: pulse 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); opacity: 0.8; }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    .animate-bounce {
        animation: bounce 1s infinite;
    }

    @keyframes fadeOut {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    }
  </style>
</head>
<body class="bg-[#FBF9F2] min-h-screen flex flex-col items-center p-4">

<h1 class="text-4xl font-extrabold text-[#2F4160] mb-8 mt-12">ğŸ‘‚ ë°›ì•„ì“°ê¸° í•™ìŠµ</h1>

<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg flex flex-col items-center space-y-6">

  <div id="question-container" class="flex flex-col items-center space-y-4 w-full">
    <p id="sentence" class="text-xl text-[#2F4160] font-semibold text-center leading-relaxed">ë¬¸ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <button id="play-btn" style="display: none;"
            class="bg-[#F29DA0] text-white text-3xl p-4 rounded-full shadow-lg hover:bg-[#2F4160] transition duration-300 transform hover:scale-110">
      â–¶ï¸
    </button>
  </div>

  <!-- ì˜¤ë‹µ ì‹œ ì •ë‹µ í‘œì‹œ ì˜ì—­ -->
  <div id="correct-answer-box" class="hidden text-center mt-4 p-3 bg-gray-100 rounded-lg border border-gray-200">
    <p class="text-lg text-gray-700 font-medium">ì •ë‹µ: <span id="correct-answer-text" class="font-bold text-[#2F4160]"></span></p>
  </div>

  <div id="answer-input" class="flex flex-col items-center space-y-4 w-full">
    <input type="text" id="user-answer" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”"
           class="border-2 border-[#B5D0E3] rounded-lg px-4 py-3 w-full text-lg focus:outline-none focus:ring-4 focus:ring-[#F29DA0] transition duration-300 placeholder-gray-400">
    <button id="submit-btn"
            class="bg-[#F29DA0] text-white px-8 py-3 rounded-xl font-bold text-lg hover:bg-[#2F4160] transition duration-300 transform hover:scale-105 shadow-md">
      ì œì¶œí•˜ê¸°
    </button>
  </div>

  <!-- ê²°ê³¼ ë©”ì‹œì§€ ë° ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ -->
  <div class="flex flex-col items-center space-y-4 mt-6 w-full">
    <button id="next-btn" style="display: none;"
            class="bg-[#B5D0E3] text-[#2F4160] px-8 py-3 rounded-xl font-bold text-lg hover:bg-[#2F4160] hover:text-white transition duration-300 transform hover:scale-105 shadow-md">
      ë‹¤ìŒ ë¬¸ì œ
    </button>
  </div>

</div>

<!-- í”¼ë“œë°± ì•„ì´ì½˜ (O/X) -->
<div id="result-overlay" class="hidden fixed inset-0 z-10 flex items-center justify-center pointer-events-none">
  <span id="result-text" class="text-9xl font-bold"></span>
</div>

<!-- í•˜ë‹¨ ê³ ì • ë²„íŠ¼ -->
<div class="fixed bottom-6 right-6">
  <button onclick="quitLesson()"
          class="bg-gray-500 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-gray-700 transition duration-300 transform hover:scale-105 shadow-lg">
    ê·¸ë§Œí•˜ê¸°
  </button>
</div>

<script>
  let currentSentence = '';
  const synth = window.speechSynthesis;

  function showCustomMessage(message, type = 'info') {
      const messageBox = document.createElement('div');
      messageBox.textContent = message;
      let bgColor = type === 'error' ? '#F29DA0' : '#2F4160';
      messageBox.style.cssText = `
          position: fixed;
          top: 20%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: ${bgColor};
          color: white;
          padding: 15px 30px;
          border-radius: 8px;
          z-index: 1000;
          font-size: 1.1em;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          animation: fadeOut 3s forwards;
      `;
      document.body.appendChild(messageBox);

      setTimeout(() => {
          messageBox.remove();
      }, 3000);
  }

  function quitLesson() {
      if (window.opener) {
          window.close();
      } else {
          showCustomMessage("ì´ ì°½ì€ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì—´ë ¸ê¸° ë•Œë¬¸ì— ìë™ìœ¼ë¡œ ë‹«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'info');
      }
  }

  function fetchAndDisplaySentence() {
      document.getElementById('sentence').textContent = 'ë¬¸ì¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      document.getElementById('user-answer').value = '';
      document.getElementById('result-overlay').classList.add('hidden');
      document.getElementById('next-btn').style.display = 'none';
      document.getElementById('play-btn').style.display = 'none';
      document.getElementById('correct-answer-box').classList.add('hidden');

      fetch(`${window.location.origin}/study/api/get-lesson4-sentence`)
      .then(res => res.json())
      .then(data => {
          if (data && data.sentence) {
              currentSentence = data.sentence;
              document.getElementById('sentence').textContent = "ë¬¸ì¥ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.";
              document.getElementById('play-btn').style.display = 'inline-block';
          } else {
              showCustomMessage('ë” ì´ìƒ í’€ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆì–´ìš”!', 'info');
              document.getElementById('sentence').textContent = '';
              document.getElementById('play-btn').style.display = 'none';
              document.getElementById('submit-btn').style.display = 'none';
              document.getElementById('user-answer').style.display = 'none';
          }
      })
      .catch(() => showCustomMessage('ë¬¸ì¥ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'));
  }

  function speakText(text) {
      if (synth.speaking) return;
      if (text) {
          const utterThis = new SpeechSynthesisUtterance(text);
          utterThis.lang = 'ko-KR';
          synth.speak(utterThis);
      }
  }

  document.getElementById('play-btn').addEventListener('click', () => speakText(currentSentence));

  document.getElementById('submit-btn').addEventListener('click', function() {
      const userAnswer = document.getElementById('user-answer').value.trim();
      if (!userAnswer) { showCustomMessage("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error'); return; }

      fetch(`${window.location.origin}/study/api/check-lesson4-answer`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ originalSentence: currentSentence, userAnswer })
      })
      .then(res => res.json())
      .then(data => {
          const overlay = document.getElementById('result-overlay');
          const text = document.getElementById('result-text');

          if (data.isCorrect) {
              text.textContent = 'âœ”ï¸';
              text.className = 'text-[#2F4160] text-9xl font-bold animate-pulse';
              document.getElementById('correct-answer-box').classList.add('hidden');
          } else {
              text.textContent = 'âŒ';
              text.className = 'text-[#F29DA0] text-9xl font-bold animate-bounce';
              document.getElementById('correct-answer-box').classList.remove('hidden');
              document.getElementById('correct-answer-text').textContent = currentSentence;
          }

          overlay.classList.remove('hidden');
          document.getElementById('next-btn').style.display = 'block';

          setTimeout(() => overlay.classList.add('hidden'), 1500);
      })
      .catch(() => showCustomMessage('ë‹µë³€ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'));
  });

  document.getElementById('next-btn').addEventListener('click', fetchAndDisplaySentence);

  window.onload = () => {
      if ('speechSynthesis' in window) fetchAndDisplaySentence();
      else showCustomMessage('ì´ ë¸Œë¼ìš°ì €ëŠ” í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
  };
</script>

</body>
</html>
