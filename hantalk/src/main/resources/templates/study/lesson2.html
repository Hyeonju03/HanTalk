<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    .container {
        min-height: 50px;
        border: 2px dashed #ccc;
        margin-bottom: 20px;
        padding: 10px;
        display: flex;
        gap: 10px;
    }
    .sentence-piece {
        padding: 10px;
        background-color: #f0f0f0; /* 회색으로 칠해져있는 칸 */
        border: 1px solid #ddd;
        cursor: grab;
        user-select: none;
    }
    .is-dragging {
        opacity: 0.5;
    }

    #feedback-icon {
        position: fixed; /* 화면 중앙에 고정 */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 100px;
        font-weight: bold;
        display: none; /* 초기에는 숨김 */
        z-index: 100; /* 다른 요소들 위에 표시 */
    }

    .correct {
        color: green;
    }

    .incorrect {
        color: red;
    }

    #next-problem-button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        display: none;
    }

    @keyframes shake {
        10%, 90% { transform: translateX(-5px); }
        20%, 80% { transform: translateX(5px); }
        30%, 70% { transform: translateX(-5px); }
        40%, 60% { transform: translateX(5px); }
    }

    .shake {
        animation: shake 0.5s ease-in-out;
    }
  </style>
</head>
<body>
<h1>문장 순서 맞추기</h1>

<div id="shuffled-container" class="container">
</div>

<hr>

<div id="sorted-container" class="container">
</div>

<button id="check-button">정답 확인</button>

<div id="feedback-icon"></div>
<button id="next-problem-button" style="display: none;">다음 문제</button>
<button id="quitBtn" onclick="quitLesson()">그만하기</button>

<div id="result-message"></div>

<script>
  let sentenceId = null; // 모든 함수 위에서 선언

  function quitLesson() {
      if (window.opener) {
          window.close();
      } else {
          alert("이 창은 브라우저에서 직접 열렸기 때문에 자동으로 닫을 수 없습니다.");
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
      loadNewProblem();

      document.getElementById('check-button').addEventListener('click', checkAnswer);
      document.getElementById('next-problem-button').addEventListener('click', loadNewProblem);

      const containers = document.querySelectorAll('.container');
      containers.forEach(container => {
          container.addEventListener('dragover', e => {
              e.preventDefault();
              const draggable = document.querySelector('.is-dragging');
              const afterElement = getDragAfterElement(container, e.clientX);
              if (afterElement == null) {
                  container.appendChild(draggable);
              } else {
                  container.insertBefore(draggable, afterElement);
              }
          });
      });
  });

  function loadNewProblem() {
      document.getElementById('feedback-icon').style.display = 'none';
      document.getElementById('next-problem-button').style.display = 'none';
      document.getElementById('result-message').textContent = '';
      document.getElementById('check-button').style.display = 'block';

      fetch('/study/api/get-lesson2-sentence')
          .then(response => response.json())
          .then(data => {
              if (data.error) {
                  alert(data.error);
                  return;
              }
              sentenceId = data.sentenceId; // 전역 변수에 저장
              displayPieces(data.pieces);
          })
          .catch(error => {
              console.error('Error loading problem:', error);
              alert('문제 로딩에 실패했습니다.');
          });
  }

  function displayPieces(pieces) {
      const shuffledContainer = document.getElementById('shuffled-container');
      shuffledContainer.innerHTML = '';
      document.getElementById('sorted-container').innerHTML = '';

      pieces.forEach(pieceText => {
          const pieceDiv = document.createElement('div');
          pieceDiv.className = 'sentence-piece';
          pieceDiv.textContent = pieceText;
          pieceDiv.setAttribute('draggable', true);

          pieceDiv.addEventListener('dragstart', () => {
              pieceDiv.classList.add('is-dragging');
          });

          pieceDiv.addEventListener('dragend', () => {
              pieceDiv.classList.remove('is-dragging');
          });

          shuffledContainer.appendChild(pieceDiv);
      });
  }

  function checkAnswer() {
      const userPieces = Array.from(document.getElementById('sorted-container').children)
                              .map(el => el.textContent);

      if (userPieces.length === 0) {
          alert('먼저 문장 조각을 배치해주세요.');
          return;
      }

      fetch('/study/api/check-lesson2-answer', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userPieces: userPieces })
      })
      .then(response => response.json())
      .then(data => {
          const feedbackIcon = document.getElementById('feedback-icon');
          const nextButton = document.getElementById('next-problem-button');
          const sortedContainer = document.getElementById('sorted-container');

          if (data.isCorrect) {
              feedbackIcon.textContent = 'O';
              feedbackIcon.className = 'correct';
              feedbackIcon.style.display = 'block';
              nextButton.style.display = 'block';
              document.getElementById('check-button').style.display = 'none'; // 정답 확인 버튼 숨기기
              // 다음 문제 id 업데이트
              if (data.nextSentenceId) {
                  sentenceId = data.nextSentenceId;
              }
          } else {
              if (data.message.includes('3번 틀렸습니다.')) {
                  feedbackIcon.textContent = 'X';
                  feedbackIcon.className = 'incorrect';
                  feedbackIcon.style.display = 'block';
                  nextButton.style.display = 'block';
                  document.getElementById('check-button').style.display = 'none'; // 정답 확인 버튼 숨기기
                  // 다음 문제 id 업데이트
                  if (data.nextSentenceId) {
                      sentenceId = data.nextSentenceId;
                  }
              } else {
                  // 2번까지 틀렸을 경우
                  sortedContainer.classList.add('shake');
                  sortedContainer.addEventListener('animationend', () => {
                      sortedContainer.classList.remove('shake');

                      const shuffledContainer = document.getElementById('shuffled-container');
                      while(sortedContainer.firstChild) {
                          shuffledContainer.appendChild(sortedContainer.firstChild);
                      }
                  }, { once: true });
              }
          }

          document.getElementById('result-message').textContent = data.message;
      })
      .catch(error => {
          console.error('Error checking answer:', error);
          alert('정답 확인 중 오류가 발생했습니다.');
      });
  }

  function getDragAfterElement(container, x) {
      const draggableElements = [...container.querySelectorAll('.sentence-piece:not(.is-dragging)')];

      return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = x - box.left - box.width / 2;
          if (offset < 0 && offset > closest.offset) {
              return { offset: offset, element: child };
          } else {
              return closest;
          }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
  }
</script>
</body>
</html>