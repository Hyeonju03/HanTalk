<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>4지선다 객관식 학습</title>
    <style>
        #feedback-icon {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            font-weight: bold;
            display: none;
            z-index: 100;
        }

        .correct { color: green; }
        .incorrect { color: red; }

        button {
            font-size: 16px;
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }

        input[type="radio"] {
            margin-right: 8px;
        }

        #result {
            font-size: 18px;
            margin-top: 15px;
        }

        #completion-message {
            font-size: 22px;
            font-weight: bold;
            color: #003366;
            margin-top: 30px;
            text-align: center;
        }

        #bottom-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
    </style>

    <script th:inline="javascript">
        let questions = /*[[${questions}]]*/ [];
        let answered = false;
        let selectedOption = "";

        window.onload = function () {
            if (questions.length > 0) {
                showQuestion(questions[0]);
            } else {
                document.getElementById('description').textContent = "";
                document.getElementById('completion-message').textContent = "더 이상 풀 문제가 없습니다.";
            }
        };

        function showQuestion(question) {
            document.getElementById('description').textContent = question.description;

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = "";

            question.options.forEach(option => {
                const optionHtml = `
                    <label>
                        <input type="radio" name="option" value="${option}" onclick="selectOption('${option}')">
                        ${option}
                    </label><br>
                `;
                optionsContainer.innerHTML += optionHtml;
            });

            document.getElementById('result').textContent = "";
            document.getElementById('feedback-icon').style.display = 'none';
            answered = false;
        }

        function selectOption(option) {
            selectedOption = option;
        }

        function submitAnswer() {
            if (!selectedOption) {
                alert("답을 선택해주세요.");
                return;
            }
            if (answered) return;
            answered = true;

            const question = questions[0];
            const correctAnswer = question.answer;
            const vocaId = question.vocaId;
            const isCorrect = selectedOption === correctAnswer;

            document.getElementById('result').textContent = isCorrect
                ? `정답! (${correctAnswer})`
                : `오답! 정답은 ${correctAnswer}`;
            showFeedback(isCorrect);

            // 서버에 정답 체크 요청
            fetch('/study/lesson3/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    vocaId: vocaId,
                    answer: selectedOption,
                    correctAnswer: correctAnswer
                })
            })
            .then(res => res.json())
            .then(result => console.log("정답 여부:", result))
            .catch(err => console.error("정답 체크 오류:", err));
        }

        function showFeedback(isCorrect) {
            const icon = document.getElementById('feedback-icon');
            icon.textContent = isCorrect ? 'O' : 'X';
            icon.className = isCorrect ? 'correct' : 'incorrect';
            icon.style.display = 'block';
        }

        function nextQuestion() {
            if (!answered) {
                alert("먼저 정답을 제출하세요.");
                return;
            }
            location.reload(); // 다음 문제 요청
        }

        function quitLesson() {
            if (window.opener) {
                window.close();
            } else {
                alert("이 창은 브라우저에서 직접 열렸기 때문에 자동으로 닫을 수 없습니다.");
            }
        }
    </script>
</head>
<body>
<h1>4지선다 객관식 학습</h1>

<p id="description"></p>
<div id="options"></div>
<button onclick="submitAnswer()">제출</button>
<button onclick="nextQuestion()">다음으로</button>

<p id="result"></p>
<p id="completion-message"></p>
<div id="feedback-icon"></div>

<!-- ✅ 하단 고정 버튼 -->
<div id="bottom-buttons">
    <button onclick="quitLesson()">그만하기</button>
</div>
</body>
</html>
