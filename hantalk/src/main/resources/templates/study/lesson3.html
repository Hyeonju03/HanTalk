<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>4지선다 객관식 학습</title>
    <style>
        #feedback-icon {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            font-weight: bold;
            display: none;
            z-index: 100;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }

        button {
            font-size: 16px;
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }

        input[type="radio"] {
            margin-right: 8px;
        }

        #result {
            font-size: 18px;
            margin-top: 15px;
        }

        #completion-message {
            font-size: 22px;
            font-weight: bold;
            color: #003366;
            margin-top: 30px;
            text-align: center;
        }
    </style>

    <script th:inline="javascript">
        let questions = /*[[${questions}]]*/ [];
        let currentIndex = 0;
        let answered = false;
        let selectedOption = "";

        window.onload = function () {
            showQuestion(currentIndex);
        };

        function showQuestion(index) {
            const question = questions[index];
            document.getElementById('description').textContent = question.description;

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = "";

            question.options.forEach(option => {
                const optionHtml = `
                    <label>
                        <input type="radio" name="option" value="${option}" onclick="selectOption('${option}')">
                        ${option}
                    </label><br>
                `;
                optionsContainer.innerHTML += optionHtml;
            });

            document.getElementById('result').textContent = "";
            document.getElementById('feedback-icon').style.display = 'none';
            document.getElementById('completion-message').textContent = '';
            answered = false;
        }

        function selectOption(option) {
            selectedOption = option;
        }

            function submitAnswer() {
        if (!selectedOption) {
            alert("답을 선택해주세요.");
            return;
        }

        if (answered) return;
        answered = true;

        const question = questions[currentIndex];
        const correctAnswer = question.answer;
        const targetId = question.vocaId;

        if (selectedOption === correctAnswer) {
            document.getElementById('result').textContent = `정답! (${correctAnswer})`;
            showFeedback(true);
        } else {
            document.getElementById('result').textContent = `오답! 정답은 ${correctAnswer}`;
            showFeedback(false);
        }

        // 오답노트 처리
        fetch('/study/check', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                type: 'word',
                targetId: targetId,
                answer: selectedOption,
                correctAnswer: correctAnswer
            })
        });

        // ✅ 5번째 문제일 경우에만 학습 완료 로그 저장
        if (currentIndex === questions.length - 1) {
            showCompletionMessage(); // 이건 기존에 있던 함수
            fetch('/study/complete3', { method: 'POST' })
                .then(res => res.text())
                .then(result => console.log("학습 로그 저장 결과:", result));
        }
    }


        function showFeedback(isCorrect) {
            const icon = document.getElementById('feedback-icon');
            icon.textContent = isCorrect ? 'O' : 'X';
            icon.className = isCorrect ? 'correct' : 'incorrect';
            icon.style.display = 'block';
        }

        function nextQuestion() {
            if (!answered) {
                alert("먼저 정답을 제출하세요.");
                return;
            }

            if (currentIndex < questions.length - 1) {
                currentIndex++;
                selectedOption = "";
                showQuestion(currentIndex);
            } else {
                showCompletionMessage();
            }
        }

        function showCompletionMessage() {
            document.getElementById('completion-message').textContent = '학습이 완료되었습니다!';
            document.getElementById('restartBtn').style.display = 'inline-block';
        }

        function restartLesson() {
            fetch('/study/api/lesson3-random')
                .then(response => {
                    if (!response.ok) throw new Error("서버 오류");
                    return response.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {
                        alert("문제를 불러올 수 없습니다.");
                        return;
                    }
                    questions = data;
                    currentIndex = 0;
                    selectedOption = "";
                    answered = false;
                    document.getElementById('restartBtn').style.display = 'none';
                    document.getElementById('completion-message').textContent = '';
                    showQuestion(currentIndex);
                })
                .catch(error => {
                    console.error("이어하기 오류:", error);
                    alert("문제 재로딩 중 오류가 발생했습니다.");
                });
        }
    </script>
</head>
<body>
<h1>4지선다 객관식 학습</h1>

<p id="description"></p>
<div id="options"></div>
<button type="button" onclick="submitAnswer()">제출</button>
<button type="button" onclick="nextQuestion()">다음으로</button>
<p id="result"></p>

<div id="feedback-icon"></div>
<p id="completion-message"></p>

<div style="position: fixed; bottom: 20px; right: 20px;">
    <button onclick="window.close()">그만하기</button>
    <button id="restartBtn" onclick="restartLesson()" style="display: none;">이어하기</button>
</div>
</body>
</html>
