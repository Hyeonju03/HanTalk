<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Game 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen font-sans flex flex-col">

<!-- header.html의 headerFragment 삽입 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="w-full flex justify-center">
    <div class="w-full max-w-7xl flex flex-col items-end p-5">
        <a href="/game/main" class="inline-block bg-[#B5D0E3] text-white py-2 px-4 rounded-lg shadow-md hover:bg-[#93b4cc] transition-colors duration-200">
            돌아가기
        </a>

        <div id="unity-container" class="w-full flex flex-col justify-center items-center mt-4 gap-2">
            <!-- 로딩바 -->
            <div id="loading-bar" class="w-1/2 h-5 bg-[#444] rounded-lg overflow-hidden">
                <div id="loading-bar-progress" class="h-full w-0 bg-green-500 transition-all duration-300 ease-in-out"></div>
            </div>
            <div id="loading-text" class="text-white">Loading...</div>

            <!-- Unity Canvas -->
            <canvas id="unity-canvas"
                    class="hidden w-full aspect-video border-2 border-white box-border"></canvas>
        </div>

        <!-- IME 입력용 숨김 input -->
        <input type="text" id="external-input"
               class="absolute bottom-2 left-2 w-52 h-8 opacity-0 text-transparent bg-transparent border-none z-10"
               autocomplete="off">
    </div>
</main>
<div th:replace="~{fragments/footer :: footerFragment}"></div>
<script>
    const canvas = document.getElementById("unity-canvas");
    const loadingBar = document.getElementById("loading-bar-progress");
    const loadingText = document.getElementById("loading-text");
    const externalInput = document.getElementById("external-input");

    // ✅ 빌드 폴더가 game2
    const BUILD_BASE = "/unity-builds/game2";
    const BUILD_URL  = BUILD_BASE + "/Build";
    const STREAMING_ASSETS_URL = BUILD_BASE + "/StreamingAssets";

    const BASE_NAME_CANDIDATES = ["unity_build_webgl", "buildUnity"];
    const USE_UNITYWEB = true;
    const DECOMPRESSION_FALLBACK = false;

    function makeConfig(baseName){
      return {
        dataUrl:      `${BUILD_URL}/${baseName}.data` + (USE_UNITYWEB ? `.unityweb` : ``),
        frameworkUrl: `${BUILD_URL}/${baseName}.framework.js` + (USE_UNITYWEB ? `.unityweb` : ``),
        codeUrl:      `${BUILD_URL}/${baseName}.wasm` + (USE_UNITYWEB ? `.unityweb` : ``),
        streamingAssetsUrl: STREAMING_ASSETS_URL,
        companyName: "YourCompany",
        productName: "Typing Game (game2)",
        productVersion: "1.0",
        decompressionFallback: DECOMPRESSION_FALLBACK,
        matchWebGLToCanvasSize: true,
        devicePixelRatio: 1
      };
    }

    function loadUnityWithBase(baseNameIndex){
      if (baseNameIndex >= BASE_NAME_CANDIDATES.length){
        loadingText.textContent = "Failed to load Unity loader.js (no baseName matched)";
        console.error("No Unity loader matched in", BASE_NAME_CANDIDATES);
        return;
      }

      const baseName = BASE_NAME_CANDIDATES[baseNameIndex];
      const loaderUrl = `${BUILD_URL}/${baseName}.loader.js`;
      const config = makeConfig(baseName);

      const script = document.createElement("script");
      script.src = loaderUrl;

      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          const pct = (progress * 100).toFixed(0);
          loadingBar.style.width = pct + "%";
          loadingText.textContent = `Loading... ${pct}%`;
        }).then((unityInstance) => {
          window.unityInstance = unityInstance;
          document.getElementById("loading-bar").classList.add('hidden');
          loadingText.classList.add('hidden');
          canvas.classList.remove('hidden');
          canvas.tabIndex = -1;
          externalInput.focus();
        }).catch((err) => {
          console.error(`[Unity] createUnityInstance failed with base "${baseName}"`, err);
          loadUnityWithBase(baseNameIndex + 1);
        });
      };

      script.onerror = () => {
        console.warn(`[Unity] loader not found: ${loaderUrl}, try next baseName...`);
        loadUnityWithBase(baseNameIndex + 1);
      };

      document.body.appendChild(script);
    }

    loadUnityWithBase(0);

    function _FocusExternalInput(){ setTimeout(() => externalInput.focus(), 0); }
    canvas.addEventListener('mousedown', _FocusExternalInput);

    externalInput.addEventListener('input', (e) => {
      if (window.unityInstance){
        window.unityInstance.SendMessage('InputManager', 'ReceiveInputFromWeb', e.target.value);
      }
    });

    externalInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        const text = externalInput.value.trim();
        if (text.length > 0 && window.unityInstance){
          window.unityInstance.SendMessage('InputManager', 'SubmitInputFromWeb', text);
        }
        externalInput.value = '';
      }
    });

    window.ReceivePointsFromUnity = function(points){
      console.log(`[JS] Received points from Unity: ${points}`);
      fetch("/game/api/users/updatePoints", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ points: parseInt(points) })
      })
      .then(res => {
        if (!res.ok) return res.json().then(e => { throw new Error(JSON.stringify(e)); });
        return res.json();
      })
      .then(data => console.log("[JS] Server response:", data))
      .catch(err => console.error("[JS] Error:", err));
    };
</script>
</body>
</html>
