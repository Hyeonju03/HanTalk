<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Typing Game (game2)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{
          margin:0; padding:0;
          display:flex; justify-content:center; align-items:flex-start;
          min-height:100vh; background-color:#222; color:#fff; font-family:sans-serif;
        }

        /* 화면 전체 높이를 쓰며 가운데 정렬 */
        #unity-container{
          width:100%;
          height:100vh; /* 필요 시 80vh로 바꾸되 아래 canvas width 식도 같이 조정 */
          display:flex; justify-content:center; align-items:center;
          flex-direction:column;
          gap:10px;
        }

        /* 잘림 방지: 16:9 비율 유지 + 화면에 맞게 축소/확대 */
        #unity-canvas{
          display:none;              /* 로딩 완료 후 JS에서 block 처리 */
          aspect-ratio: 16 / 9;
          width: min(100vw, 100vh * 16 / 9);
          height: auto;              /* aspect-ratio에 의해 자동 계산 */
          max-width: 100vw;
          max-height: 100vh;
          border: 2px solid #fff;
          box-sizing: border-box;
        }

        /* input은 보이지 않지만 IME(한글 입력기) 동작 가능해야 함 */
        #external-input{
          position:absolute; bottom:10px; left:10px;
          width:200px; height:30px;
          opacity:0; color:transparent; background:transparent; border:none;
          z-index:10;
        }

        #loading-bar{
          width:min(600px, 80vw);
          height:20px;
          background:#444;
          border-radius:10px;
          overflow:hidden;
        }
        #loading-bar-progress{ width:0%; height:100%; background:#00ff00; }
        #loading-text{ color:#fff; }
    </style>
</head>
<body>
<div id="unity-container">
    <div id="loading-bar"><div id="loading-bar-progress"></div></div>
    <div id="loading-text">Loading...</div>
    <canvas id="unity-canvas"></canvas>
</div>

<input type="text" id="external-input" autocomplete="off">

<script>
    const canvas = document.getElementById("unity-canvas");
    const loadingBar = document.getElementById("loading-bar-progress");
    const loadingText = document.getElementById("loading-text");
    const externalInput = document.getElementById("external-input");

    // ✅ 빌드 폴더가 game2
    const BUILD_BASE = "/unity-builds/game2";
    const BUILD_URL  = BUILD_BASE + "/Build";
    const STREAMING_ASSETS_URL = BUILD_BASE + "/StreamingAssets";

    // ✅ 폴더 안 파일 베이스명 후보(스크린샷 기준 둘 다 존재 가능)
    const BASE_NAME_CANDIDATES = ["unity_build_webgl", "buildUnity"]; // 순서대로 시도

    // ✅ 압축 산출물 사용 여부 (운영 권장: true)
    // true  → *.unityweb 파일들을 로드(서버에서 Content-Encoding 헤더 필요; 임시는 Fallback로 완화)
    // false → 비압축 *.data/*.framework.js/*.wasm 로드
    const USE_UNITYWEB = true;

    // ✅ 서버가 *.unityweb에 Content-Encoding 헤더를 아직 못 달아줄 때 임시 완화
    //   - 임시 테스트: true
    //   - 운영(헤더 세팅 완료): false
    const DECOMPRESSION_FALLBACK = false; // 필요시 true로

    // ====== 공통 설정 생성 ======
    function makeConfig(baseName){
      return {
        dataUrl:      `${BUILD_URL}/${baseName}.data` + (USE_UNITYWEB ? `.unityweb` : ``),
        frameworkUrl: `${BUILD_URL}/${baseName}.framework.js` + (USE_UNITYWEB ? `.unityweb` : ``),
        codeUrl:      `${BUILD_URL}/${baseName}.wasm` + (USE_UNITYWEB ? `.unityweb` : ``),
        streamingAssetsUrl: STREAMING_ASSETS_URL,
        companyName: "YourCompany",
        productName: "Typing Game (game2)",
        productVersion: "1.0",
        decompressionFallback: DECOMPRESSION_FALLBACK,

        /* ▼ 잘림 방지 세팅: CSS 크기에 내부 렌더 버퍼를 맞추고, DPR=1로 과도한 해상도 방지 */
        matchWebGLToCanvasSize: true,
        devicePixelRatio: 1
      };
    }

    // ====== 로더 스크립트 동적 주입 + 베이스명 폴백 ======
    function loadUnityWithBase(baseNameIndex){
      if (baseNameIndex >= BASE_NAME_CANDIDATES.length){
        loadingText.textContent = "Failed to load Unity loader.js (no baseName matched)";
        console.error("No Unity loader matched in", BASE_NAME_CANDIDATES);
        return;
      }

      const baseName = BASE_NAME_CANDIDATES[baseNameIndex];
      const loaderUrl = `${BUILD_URL}/${baseName}.loader.js`;
      const config = makeConfig(baseName);

      const script = document.createElement("script");
      script.src = loaderUrl;

      script.onload = () => {
        // Unity 로딩
        createUnityInstance(canvas, config, (progress) => {
          const pct = (progress * 100).toFixed(0);
          loadingBar.style.width = pct + "%";
          loadingText.textContent = `Loading... ${pct}%`;
        }).then((unityInstance) => {
          window.unityInstance = unityInstance;
          document.getElementById("loading-bar").style.display = "none";
          loadingText.style.display = "none";
          canvas.style.display = "block";

          // 캔버스가 키 입력 안 가로채도록 & 포커스 초기화
          canvas.tabIndex = -1;
          externalInput.focus();
        }).catch((err) => {
          console.error(`[Unity] createUnityInstance failed with base "${baseName}"`, err);
          // 로더는 로드됐지만 내부 리소스 실패 등일 경우 다음 후보 시도
          loadUnityWithBase(baseNameIndex + 1);
        });
      };

      script.onerror = () => {
        console.warn(`[Unity] loader not found: ${loaderUrl}, try next baseName...`);
        loadUnityWithBase(baseNameIndex + 1);
      };

      document.body.appendChild(script);
    }

    // 시작: 첫 후보부터 시도
    loadUnityWithBase(0);

    // ====== 외부 입력창 포커스 유지 & Unity로 전달 ======
    function _FocusExternalInput(){ setTimeout(() => externalInput.focus(), 0); }
    canvas.addEventListener('mousedown', _FocusExternalInput);

    // 입력 변화 시 Unity로 텍스트 전달
    externalInput.addEventListener('input', (e) => {
      if (window.unityInstance){
        window.unityInstance.SendMessage('InputManager', 'ReceiveInputFromWeb', e.target.value);
      }
    });

    // 엔터 시 확정 전송
    externalInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){
        const text = externalInput.value.trim();
        if (text.length > 0 && window.unityInstance){
          window.unityInstance.SendMessage('InputManager', 'SubmitInputFromWeb', text);
        }
        externalInput.value = '';
      }
    });

    // ====== Unity → JS 콜백 (포인트 수신 후 서버 반영) ======
    function ReceivePointsFromUnity(points){
      console.log(`[JS] Received points from Unity: ${points}`);
      fetch("/game/api/users/updatePoints", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ points: parseInt(points) })
      })
      .then(res => {
        if (!res.ok) return res.json().then(e => { throw new Error(JSON.stringify(e)); });
        return res.json();
      })
      .then(data => console.log("[JS] Server response:", data))
      .catch(err => console.error("[JS] Error:", err));
    }
</script>
</body>
</html>
