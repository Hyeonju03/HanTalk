<!DOCTYPE html>
<html lang="en-us" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>Play tag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen font-sans flex flex-col">

<!-- header.html의 headerFragment 삽입 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="flex justify-center">
  <div class="w-full max-w-7xl flex flex-col items-end p-5">
    <a href="/game/main" class="inline-block bg-[#B5D0E3] text-white py-2 px-4 rounded-lg shadow-md hover:bg-[#93b4cc] transition-colors duration-200">
      돌아가기
    </a>
    <div id="unity-container" class="w-full flex flex-col justify-center items-center mt-4">
      <div id="loading-bar-progress" class="h-full w-0 bg-green-500 transition-all duration-300 ease-in-out"></div>
    </div>
    <div id="loading-text" class="text-white"></div>
    <canvas id="unity-canvas" class="w-full aspect-video border-2 border-white box-border"></canvas>
  </div>
</main>

<div th:replace="~{fragments/footer :: footerFragment}"></div>

<div id="unity-loading-bar">
  <div id="unity-logo"></div>
  <div id="unity-progress-bar-empty">
    <div id="unity-progress-bar-full"></div>
  </div>
</div>
<div id="unity-warning"></div>
<div id="unity-footer">
  <div id="unity-webgl-logo"></div>
  <div id="unity-fullscreen-button"></div>
  <div id="unity-build-title"></div>
</div>

<script>
  // -----------------------------
  // 1. 배너 경고 표시
  // -----------------------------
  var warningBanner = document.querySelector("#unity-warning");
  function unityShowBanner(msg, type) {
      function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
      }
      var div = document.createElement('div');
      div.innerHTML = msg;
      warningBanner.appendChild(div);
      if (type === 'error') div.style = 'background: red; padding: 10px;';
      else if (type === 'warning') div.style = 'background: yellow; padding: 10px;';
      if(type !== 'error') {
          setTimeout(() => { warningBanner.removeChild(div); updateBannerVisibility(); }, 5000);
      }
      updateBannerVisibility();
  }

  // -----------------------------
  // 2. Unity WebGL Loader 설정
  // -----------------------------
  var buildUrl = "/unity-builds/game3/Build";
  var loaderUrl = buildUrl + "/WebGL.loader.js";
  var canvas = document.querySelector("#unity-canvas");

  var config = {
      dataUrl: buildUrl + "/WebGL.data",
      frameworkUrl: buildUrl + "/WebGL.framework.js",
      codeUrl: buildUrl + "/WebGL.wasm",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "DefaultCompany",
      productName: "Play tag",
      productVersion: "1.0",
      showBanner: unityShowBanner
  };

  var script = document.createElement("script");
  script.src = loaderUrl;
  script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
      }).then(unityInstance => {
          console.log("Unity loaded!");
          document.querySelector("#unity-fullscreen-button").onclick = () => {
              unityInstance.SetFullscreen(1);
          };
      }).catch(err => console.error(err));
  };
  document.body.appendChild(script);

  // -----------------------------
  // 3. Unity → JS 점수 전송
  // -----------------------------
function ReceivePointsFromUnity(points) {
    console.log("[JS] Unity에서 받은 점수:", points);

    fetch("/game/api/users/updatePoints", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ points: parseInt(points) })
    })
    .then(res => {
        console.log("[JS] fetch 완료, status:", res.status);
        if (!res.ok) return res.json().then(err => { throw new Error(JSON.stringify(err)); });
        return res.json();
    })
    .then(data => console.log("[JS] 서버 응답:", data))
    .catch(err => console.error("[JS] Error:", err));
}


  // 반드시 window 객체에 등록
  window.ReceivePointsFromUnity = ReceivePointsFromUnity;
</script>

</body>
</html>
