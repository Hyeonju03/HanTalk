<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Typing Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="w-full flex justify-center items-center">
    <div class="w-full max-w-7xl flex flex-col items-end p-5">
        <a href="/game/main" class="inline-block bg-[#B5D0E3] text-white py-2 px-4 rounded-lg shadow-md hover:bg-[#93b4cc] transition-colors duration-200">
            돌아가기
        </a>
        <div id="unity-container" class="w-full flex flex-col justify-center items-center mt-4">
            <div id="loading-bar" class="w-1/2 h-5 bg-[#444] rounded-lg overflow-hidden mb-2">
                <div id="loading-bar-progress" class="h-full bg-green-500 transition-all duration-300 ease-in-out"></div>
            </div>
            <div id="loading-text" class="text-white">Loading...</div>
            <canvas id="unity-canvas" class="w-full aspect-video border-2 border-white hidden"></canvas>
        </div>
    </div>
</main>
<div th:replace="~{fragments/footer :: footerFragment}"></div>
<script>
    const canvas = document.getElementById("unity-canvas");
    const loadingBar = document.getElementById("loading-bar-progress");
    const loadingText = document.getElementById("loading-text");
    const externalInput = document.getElementById("external-input");
    // Unity Build 경로
    const buildUrl = "/unity-builds/game1/Build";
    const loaderUrl = buildUrl + "/Build.loader.js";
    const config = {
        dataUrl: buildUrl + "/Build.data",
        frameworkUrl: buildUrl + "/Build.framework.js",
        codeUrl: buildUrl + "/Build.wasm",
        streamingAssetsUrl: "/unity-builds/game1/StreamingAssets",
        companyName: "YourCompany",
        productName: "YourProduct",
        productVersion: "1.0"
    };

    // Unity 로딩
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
            loadingBar.style.width = (progress * 100).toFixed(0) + "%";
            loadingText.textContent = `Loading... ${(progress * 100).toFixed(0)}%`;
        }).then((unityInstance) => {
            window.unityInstance = unityInstance;
            loadingText.classList.add('hidden');
            document.getElementById("loading-bar").classList.add('hidden');
            canvas.classList.remove('hidden');
            // 캔버스가 키 입력 안 가로채도록
            canvas.tabIndex = -1;
            // 처음 포커스 강제
            externalInput.focus();
        }).catch((err) => console.error(err));
    };
    document.body.appendChild(script);

    // 항상 input으로 포커스 유지
    function _FocusExternalInput() {
        setTimeout(() => externalInput.focus(), 0);
    }

    // 캔버스 클릭 시 input 다시 포커스
    canvas.addEventListener('mousedown', () => _FocusExternalInput());

    // =======================
    // 엔터 입력 기준 전송
    // =======================

    // 입력창에 글자가 입력될 때마다 Unity로 텍스트 전송
    externalInput.addEventListener('input', (e) => {
        if (window.unityInstance) {
            // Unity 스크립트의 ReceiveInputFromWeb 메서드 호출
            window.unityInstance.SendMessage('InputManager', 'ReceiveInputFromWeb', e.target.value);
        }
    });
    externalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            let text = externalInput.value.trim();
            if (text.length > 0 && window.unityInstance) {
                window.unityInstance.SendMessage('InputManager', 'SubmitInputFromWeb', text);
            }
            externalInput.value = '';
        }
        if (e.key === ' ') {
            e.preventDefault();
            let currentKey = externalInput.value;
            console.log("현재:" + currentKey + ".");
            let newKey = currentKey + ' ';
            console.log("스페이스:" + newKey + ".");

            externalInput.value = newKey;
        }
    });

    // Unity에서 호출할 함수 (포인트 값을 전달받아 서버에 전송)
    function ReceivePointsFromUnity(points) {
        console.log(`[JS] Received points from Unity: ${points}`);

        const url = "/game/api/users/updatePoints";

        fetch(url, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ points: parseInt(points) })
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(errorData => {
                    throw new Error(JSON.stringify(errorData));
                });
            }
            return res.json();
        })
        .then(data => {
            console.log("[JS] Server response:", data);
            // alert("포인트가 성공적으로 저장되었습니다!");
        })
        .catch(err => {
            console.error("[JS] Error:", err);
            // alert("포인트 저장 실패: " + err.message);
        });
    }

</script>
</body>
</html>