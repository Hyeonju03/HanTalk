<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${post.title}">게시물 제목</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        .post-content {
            white-space: pre-wrap; /* 줄바꿈, 공백 유지 */
            min-height: 200px;
        }
    </style>
</head>

<div th:replace="~{fragments/header :: headerFragment}"></div>

<body class="bg-[#f3f4f6] text-[#2F4160] font-sans antialiased min-h-screen">

<div class="container mx-auto px-4 w-full max-w-4xl mt-12">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <div class="post-header border-b-2 border-gray-300 pb-4 mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900" th:text="${post.title}">게시물 제목</h1>
            <div class="post-meta text-sm text-gray-500 mt-2 flex items-center space-x-2">
                <span th:text="${post.users.nickname}">작성자</span>
                <span>|</span>
                <span th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')}">2025-08-01 12:00</span>

                <th:block th:if="${post.updateDate != null and not #temporals.format(post.updateDate, 'yyyy-MM-dd HH:mm').equals(#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm'))}">
                    <span>|</span>
                    <span>(수정: <span th:text="${#temporals.format(post.updateDate, 'yyyy-MM-dd HH:mm')}"></span>)</span>
                </th:block>

                <span>|</span>
                <span>조회수: <span th:text="${post.viewCount}">0</span></span>
            </div>
        </div>

        <div class="post-content p-4 border rounded-lg bg-gray-50 text-gray-700">
            <p th:text="${post.content}">게시물 내용입니다.</p>
        </div>

        <div th:if="${post.archive != null}" class="mb-4 mt-6">
            <h4 class="font-bold text-lg text-gray-800">첨부파일</h4>
            <div class="flex items-center space-x-4 mt-2">
                <span th:text="${post.originalFileName}" class="text-gray-700 font-medium"></span>

                <a th:href="@{|/post/download/file/${post.archive}|}"
                   class="bg-[#B5D0E3] hover:bg-[#2F4160] text-white font-bold py-2 px-4 rounded-lg transition duration-200">다운로드</a>
            </div>
        </div>

        <div class="btn-group flex space-x-2 mt-6">
            <a th:if="${isAdmin} or (${loginUserNo != null and post.users.userNo == loginUserNo})"
               th:href="@{|/post/update/${post.postId}|}" class="bg-[#B5D0E3] hover:bg-[#2F4160] text-white font-bold py-2 px-4 rounded-lg transition duration-200"><i class="fas fa-edit"></i>수정</a>

            <button th:if="${isAdmin} or (${loginUserNo != null and post.users.userNo == loginUserNo})"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                    th:onclick="|confirmDelete(${post.postId}, ${post.category.categoryId})|"><i class="fas fa-trash"></i>삭제</button>

            <a th:href="@{|/post/list/${post.category.categoryId}|}" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">목록</a>
        </div>
        <hr class="my-8">
        <div class="comments-section" th:if="${post.category.categoryId != 1}">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">댓글 (<span id="comment-count">0</span>)</h3>

            <div class="mb-6">
                <div th:if="${isAdmin} or (${loginUserNo != null and post.users.userNo == loginUserNo})">
                    <textarea id="comment-content" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" rows="3" placeholder="댓글을 입력하세요."></textarea>
                    <button id="submit-comment-btn" class="w-full mt-2 bg-[#2F4160] hover:bg-[#2F4160] text-white font-bold py-3 px-4 rounded-lg transition duration-200">댓글 작성</button>
                </div>
                <div th:if="${!(isAdmin or (loginUserNo != null and post.users.userNo == loginUserNo))}" class="p-4 bg-blue-100 text-blue-700 rounded-lg">
                    문의사항 댓글은 작성자 또는 관리자만 작성할 수 있습니다.
                </div>
            </div>

            <div id="comments-list" class="divide-y divide-gray-200">
            </div>
        </div>

    </div>
</div>

<div id="modal-wrapper" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
    <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
        <div class="flex justify-between items-center pb-3">
            <h5 class="text-xl font-bold text-gray-800" id="modal-title">알림</h5>
            <button type="button" class="text-gray-400 hover:text-gray-600 focus:outline-none close-modal-btn">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="modal-body text-gray-700" id="modal-message">
            정말 삭제하시겠습니까?
        </div>
        <div class="modal-footer flex justify-end space-x-2 mt-6" id="modal-buttons">
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        const postId = /*[[${post.postId}]]*/ '1';
        const loginUserNo = /*[[${loginUserNo}]]*/ null;
        const postCategory = /*[[${post.category.categoryId}]]*/ '1';
        const postAuthorUserNo = /*[[${post.users.userNo}]]*/ null;
        const isAdmin = /*[[${isAdmin}]]*/ false;

        // 공지사항(카테고리 ID 1)이 아닐 경우에만 댓글 관련 기능 활성화
        if (postCategory != 1) {
            fetchComments();

            // 댓글 작성 버튼 이벤트 핸들러
            $('#submit-comment-btn').on('click', function() {
                const commentContent = $('#comment-content').val().trim();
                if (!commentContent) {
                    showModal('댓글 내용을 입력해주세요.');
                    return;
                }

                // 권한 확인 (클라이언트 측에서 한 번 더 체크)
                if (!(isAdmin || (loginUserNo != null && postAuthorUserNo === loginUserNo))) {
                    showModal('댓글 작성 권한이 없습니다.');
                    return;
                }

                const commentData = {
                    postId: postId,
                    content: commentContent
                };

                $.ajax({
                    url: '/api/comments/create',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(commentData),
                    success: function(createdComment) {
                        $('#comment-content').val('');
                        fetchComments();
                    },
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            showModal('로그인이 필요합니다.');
                        } else if (xhr.status === 403) {
                            showModal('댓글 작성 권한이 없습니다.');
                        } else {
                            showModal('댓글 작성 중 오류가 발생했습니다.');
                        }
                        console.error('댓글 작성 오류:', xhr.status, xhr.responseText);
                    }
                });
            });

            // 댓글 삭제 버튼 이벤트 핸들러
            $('#comments-list').on('click', '.delete-comment-btn', function() {
                const commentId = $(this).data('comment-id');
                showConfirmModal('정말 이 댓글을 삭제하시겠습니까?', () => {
                    $.ajax({
                        url: `/api/comments/${commentId}`,
                        type: 'DELETE',
                        success: function(result) {
                            showModal('댓글이 삭제되었습니다.', fetchComments);
                        },
                        error: function(xhr) {
                            if (xhr.status === 401) {
                                showModal('로그인이 필요합니다.');
                            } else if (xhr.status === 403) {
                                showModal('삭제 권한이 없습니다.');
                            } else {
                                showModal('댓글 삭제 중 오류가 발생했습니다.');
                            }
                            console.error('댓글 삭제 오류:', xhr.status, xhr.responseText);
                        }
                    });
                });
            });

            // 댓글 수정 버튼 이벤트 핸들러
            $('#comments-list').on('click', '.update-comment-btn', function() {
                const commentId = $(this).data('comment-id');
                const currentContent = $(this).data('comment-content');

                const newContent = prompt('새로운 댓글 내용을 입력하세요:', currentContent);

                if (newContent === null || newContent.trim() === '') {
                    if (newContent === null) {
                        return;
                    }
                    showModal('댓글 내용을 입력해야 합니다.');
                    return;
                }

                const updateData = {
                    content: newContent
                };

                $.ajax({
                    url: `/api/comments/${commentId}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(updateData),
                    success: function(updatedComment) {
                        showModal('댓글이 수정되었습니다.', fetchComments);
                    },
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            showModal('로그인이 필요합니다.');
                        } else if (xhr.status === 403) {
                            showModal('수정 권한이 없습니다.');
                        } else {
                            showModal('댓글 수정 중 오류가 발생했습니다.');
                        }
                        console.error('댓글 수정 오류:', xhr.status, xhr.responseText);
                    }
                });
            });
        }

        // 게시물 삭제 함수
        window.confirmDelete = function(postIdToDelete, categoryId) {
            if (confirm('정말로 이 게시물을 삭제하시겠습니까?')) {
                $.ajax({
                    url: `/post/deleteProc/${postIdToDelete}`,
                    type: 'DELETE',
                    success: function(result) {
                        alert('게시물이 삭제되었습니다.');
                        window.location.href = `/post/list/${categoryId}`;
                    },
                    error: function(xhr) {
                        if (xhr.status === 403) {
                            alert('삭제 권한이 없습니다.');
                        } else {
                            alert('오류가 발생했습니다.');
                        }
                        console.error('Error:', xhr.status, xhr.responseText);
                    }
                });
            }
        };

        // 댓글 목록을 불러와서 화면에 렌더링하는 함수
        function fetchComments() {
            if (!postId) {
                console.error("postId가 유효하지 않습니다.");
                return;
            }
            $.ajax({
                url: `/api/comments/post/${postId}`,
                type: 'GET',
                success: function(comments) {
                    console.log('API 응답 댓글 데이터:', comments);
                    const commentsList = $('#comments-list');
                    commentsList.empty();
                    $('#comment-count').text(comments.length);
                    comments.forEach(comment => {
                        commentsList.append(createCommentElement(comment));
                    });
                },
                error: function(xhr, status, error) {
                    console.error('댓글 로딩 오류:', error);
                    $('#comments-list').html('<div class="p-4 bg-red-100 text-red-700 rounded-lg" role="alert">댓글을 불러오는 데 실패했습니다.</div>');
                }
            });
        }


       // 댓글 HTML 요소를 생성하는 함수 (수정 날짜 및 수정/삭제 버튼 포함)
        function createCommentElement(comment) {
            const createDate = new Date(comment.createDate).toLocaleString('ko-KR');
            const modifiedDate = comment.updateDate ? new Date(comment.updateDate).toLocaleString('ko-KR') : null;

            const nickname = comment.nickName || '익명';
            const commentUserNo = comment.userNo;

            let commentHtml = `
                <div class="comment-item py-4 flex justify-between items-start">
                    <div class="flex-grow">
                        <p class="text-gray-800 mb-1">${comment.content}</p>
                        <div class="comment-meta text-sm text-gray-500 mt-2 flex items-center space-x-2">
                            <span class="font-semibold">${nickname}</span>
                            <span>|</span>
                            <span>${createDate}</span>
                            ${modifiedDate ? `<span>|</span><span>(수정: ${modifiedDate})</span>` : ''}
                        </div>
                    </div>
            `;

            if (commentUserNo && (commentUserNo == loginUserNo || isAdmin)) {
                commentHtml += `
                    <div class="comment-buttons flex-shrink-0 space-x-2 ml-4">
                        <button class="update-comment-btn bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" data-comment-id="${comment.commentId}" data-comment-content="${comment.content}">수정</button>
                        <button class="delete-comment-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded transition duration-200" data-comment-id="${comment.commentId}">삭제</button>
                    </div>
                `;
            }

            commentHtml += `</div>`;
            return commentHtml;
        }

        function showModal(message, onConfirm) {
            const modalWrapper = $('#modal-wrapper');
            $('#modal-title').text('알림');
            $('#modal-message').text(message);
            const modalButtons = $('#modal-buttons');
            modalButtons.html(`
                <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 close-modal-btn">확인</button>
            `);
            $('.close-modal-btn').off('click').on('click', function() {
                modalWrapper.addClass('hidden');
                if (onConfirm) onConfirm();
            });
            modalWrapper.removeClass('hidden');
        }

        function showConfirmModal(message, onConfirm) {
            const modalWrapper = $('#modal-wrapper');
            $('#modal-title').text('확인');
            $('#modal-message').text(message);
            const modalButtons = $('#modal-buttons');
            modalButtons.html(`
                <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 close-modal-btn">취소</button>
                <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 confirm-action-btn">삭제</button>
            `);

            $('.close-modal-btn').off('click').on('click', function() {
                modalWrapper.addClass('hidden');
            });

            $('.confirm-action-btn').off('click').on('click', function() {
                modalWrapper.addClass('hidden');
                onConfirm();
            });

            modalWrapper.removeClass('hidden');
        }
    });
    /*]]>*/
</script>
</body>
</html>