<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>출석 캘린더</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-main-dark { background-color: #2F4160; }
        .text-main-dark { color: #2F4160; }
        .bg-accent-pink { background-color: #F29DA0; }
        .text-accent-pink { color: #F29DA0; }
        .bg-soft-blue { background-color: #B5D0E3; }
        .text-soft-blue { color: #B5D0E3; }
        .hover-bg-soft-blue:hover { background-color: #B5D0E3; }
        .hover-text-accent-pink:hover { color: #F29DA0; }
        .container-custom { max-width: 1000px; }

        /* 기존 스타일 유지 */
        .profile-container {
          position: relative;
          width: 112px;
          height: 112px;
          margin: 0 auto;
        }
        .profile-image, .profile-frame {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
        }
        .calendar-grid-cell {
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          min-height: 100px;
          padding: 5px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 font-sans text-main-dark">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="flex-grow flex justify-center p-8 space-x-8">

    <div th:replace="~{fragments/mypageSidebar :: mypageSidebar}"></div>

    <div class="container-custom w-full">
        <div class="bg-white rounded-xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-main-dark mb-6 text-center">출석 캘린더</h1>

            <div class="bg-white rounded-xl">
                <div class="flex items-center justify-between border-b border-[#E0E0E0] p-3 select-none">
                    <button id="prevMonth" class="text-2xl hover:text-accent-pink text-main-dark">◀</button>
                    <div id="currentMonth" class="text-xl font-semibold text-main-dark"></div>
                    <button id="nextMonth" class="text-2xl hover:text-accent-pink text-main-dark">▶</button>
                </div>

                <div class="grid grid-cols-7 text-sm text-center uppercase border-b border-[#E0E0E0]">
                    <div class="py-2 text-red-600">SUN</div>
                    <div class="py-2 text-main-dark">MON</div>
                    <div class="py-2 text-main-dark">TUE</div>
                    <div class="py-2 text-main-dark">WED</div>
                    <div class="py-2 text-main-dark">THU</div>
                    <div class="py-2 text-main-dark">FRI</div>
                    <div class="py-2 text-blue-600">SAT</div>
                </div>

                <div id="calendar" class="grid grid-cols-7 gap-1 p-2 text-center text-base text-main-dark">
                </div>
            </div>

            <div class="text-center mt-6">
                <button id="checkInButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg transition-colors duration-200">
                    오늘 출석하기
                </button>
                <a href="/user/view" class="text-main-dark hover:text-accent-pink hover:underline text-lg block mt-4 transition-colors duration-200">마이 페이지로</a>
            </div>
        </div>
    </div>
</main>

<div id="alertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-40 hidden">
    <div class="bg-white p-5 md:p-6 border border-[#E0E0E0] max-w-sm w-11/12 rounded-lg text-center text-main-dark shadow-md">
        <span class="text-main-dark float-right text-2xl font-bold cursor-pointer hover:text-accent-pink" id="alertCloseBtn">&times;</span>
        <p id="alertMessage" class="mt-4 mb-4"></p>
        <button class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200" id="confirmAlertCloseBtn">확인</button>
    </div>
</div>

<div class="py-4 text-gray-500 text-center text-sm bg-gray-100" th:replace="~{fragments/footer :: footerFragment}"></div>

<script>
    const calendarEl = document.getElementById('calendar');
    const monthLabel = document.getElementById('currentMonth');
    const checkInButton = document.getElementById('checkInButton');

    const alertModal = document.getElementById('alertModal');
    const alertCloseBtn = document.getElementById('alertCloseBtn');
    const confirmAlertCloseBtn = document.getElementById('confirmAlertCloseBtn');
    const alertMessage = document.getElementById('alertMessage');

    function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.classList.remove('hidden');
        alertModal.style.display = 'flex';
    }

    alertCloseBtn.onclick = function() {
        alertModal.classList.add('hidden');
        alertModal.style.display = 'none';
    }
    confirmAlertCloseBtn.onclick = function() {
        alertModal.classList.add('hidden');
        alertModal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == alertModal) {
            alertModal.classList.add('hidden');
            alertModal.style.display = 'none';
        }
    }

    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();

    function renderCalendar(attendanceDates) {
      calendarEl.innerHTML = '';

      const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
      const lastDateOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      monthLabel.textContent = `${currentYear}.${currentMonth + 1}`;

      const startDayOffset = firstDayOfMonth;

      for (let i = 0; i < startDayOffset; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-grid-cell';
        calendarEl.appendChild(emptyCell);
      }

      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      let hasCheckedInToday = false;

      for (let day = 1; day <= lastDateOfMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-grid-cell relative rounded cursor-default border border-transparent hover:border-[#B5D0E3]/50';

        const dayText = document.createElement('div');
        dayText.textContent = day;
        dayText.className = 'font-semibold mb-1';

        const currentDayOfWeek = new Date(currentYear, currentMonth, day).getDay();

        if (currentDayOfWeek === 0) {
          dayText.classList.add('text-red-600');
        } else if (currentDayOfWeek === 6) {
          dayText.classList.add('text-blue-600');
        }

        cell.appendChild(dayText);

        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        if (attendanceDates.includes(dateStr)) {
          const imgIcon = document.createElement('img');
          imgIcon.src = '/image/chulsuk4.png';
          imgIcon.className = 'w-28 h-28 mx-auto';

          cell.appendChild(imgIcon);

          if (dateStr === todayStr) {
            hasCheckedInToday = true;
          }
        }

        if (dateStr === todayStr && currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
          cell.classList.add('border-2', 'border-accent-pink', 'bg-soft-blue/20');
        }

        calendarEl.appendChild(cell);
      }

      if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
        if (!hasCheckedInToday) {
          checkInButton.disabled = false;
          checkInButton.textContent = '오늘 출석하기';
          checkInButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
          checkInButton.classList.add('bg-accent-pink', 'hover:bg-main-dark');
        } else {
          checkInButton.disabled = true;
          checkInButton.textContent = '출석 완료!';
          checkInButton.classList.remove('bg-accent-pink', 'hover:bg-main-dark');
          checkInButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }
      } else {
        checkInButton.disabled = true;
        checkInButton.textContent = '출석할 수 없습니다';
        checkInButton.classList.remove('bg-accent-pink', 'hover:bg-main-dark');
        checkInButton.classList.add('bg-gray-400', 'cursor-not-allowed');
      }
    }

    function fetchAndRender() {
      axios.get('/user/calendar/data')
        .then(response => {
          renderCalendar(response.data);
        })
        .catch(error => {
          console.error('출석 정보 불러오기 실패:', error);
          showAlert('출석 정보를 불러오는데 실패했습니다.');
          renderCalendar([]);
        });
    }

    document.getElementById('prevMonth').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      fetchAndRender();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      fetchAndRender();
    });

    checkInButton.addEventListener('click', () => {
      if (checkInButton.disabled) {
          return;
      }

      axios.post('/user/checkTodayAttendance')
        .then(response => {
          if (response.data.success) {
            showAlert(response.data.message || '출석 완료! 10 포인트가 적립되었습니다.');
            fetchAndRender();
          } else {
            showAlert(response.data.message || '출석에 실패했습니다.');
          }
        })
        .catch(error => {
          console.error('출석 체크 중 오류 발생:', error);
          showAlert('출석 체크 중 오류가 발생했습니다. 다시 시도해 주세요.');
        });
    });

    fetchAndRender();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>