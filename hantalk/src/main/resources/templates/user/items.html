<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>보유 아이템 목록</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-10">
<div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-md">

  <h2 class="text-2xl font-bold mb-4">구매한 아이템</h2>

  <!-- 프로필 이미지 목록 -->
  <h3 class="text-xl font-semibold mt-6 mb-2">프로필 이미지 선택</h3>
  <div class="grid grid-cols-4 gap-2">
    <img th:each="img : ${profileImages}"
         th:src="@{'/images/' + ${img}}"
         th:attr="data-img=${img}"
         class="cursor-pointer border rounded-full hover:ring w-20 h-20 object-cover"
         onclick="selectProfileImage(this)">
  </div>

  <!-- 프레임 이미지 목록 -->
  <h3 class="text-xl font-semibold mt-6 mb-2">프레임 이미지 선택</h3>
  <div class="grid grid-cols-4 gap-2">
    <img th:each="frame : ${frameImages}"
         th:src="@{'/frames/' + ${frame}}"
         th:attr="data-frame=${frame}"
         class="cursor-pointer border hover:ring w-20 h-20 object-cover"
         onclick="selectFrameImage(this)">
  </div>

  <!-- 미리보기 -->
  <h3 class="text-xl font-semibold mt-6 mb-2">미리보기</h3>
  <div class="relative w-28 h-28 mx-auto mb-4">
    <img id="preview-profile" class="rounded-full object-cover absolute top-1.5 left-1.5 w-[85%] h-[85%] z-0"/>
    <img id="preview-frame" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10"/>
  </div>

  <!-- 설정 버튼 -->
  <button onclick="confirmSetting()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
    설정하기
  </button>

  <!-- 뒤로가기 버튼 -->
  <button onclick="history.back()"
          class="mt-4 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">
    뒤로가기
  </button>

  <script>
    let selectedProfileImage = null;
    let selectedFrameImage = null;

    function selectProfileImage(el) {
      selectedProfileImage = el.getAttribute("data-img");
      document.getElementById("preview-profile").src = "/images/" + selectedProfileImage;
    }

    function selectFrameImage(el) {
      selectedFrameImage = el.getAttribute("data-frame");
      document.getElementById("preview-frame").src = "/frames/" + selectedFrameImage;
    }

    function confirmSetting() {
      if (!selectedProfileImage && !selectedFrameImage) {
        alert("프로필 또는 프레임 이미지를 선택해주세요.");
        return;
      }

      const confirmed = confirm("이대로 설정하시겠습니까?");
      if (confirmed) {
        fetch("/user/apply-setting", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            profileImage: selectedProfileImage,
            profileFrame: selectedFrameImage
          })
        }).then(res => {
          if (res.ok) {
            alert("프로필이 설정되었습니다!");
            location.href = "/user/view"; // 마이페이지로 이동
          } else {
            alert("설정 실패");
          }
        });
      }
    }
  </script>

</div>
</body>
</html>