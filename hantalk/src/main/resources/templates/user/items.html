<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>보유 아이템 목록</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 프로필 이미지와 프레임이 겹쳐 보이도록 z-index 설정 */
    .profile-container {
      position: relative;
      width: 112px;
      height: 112px;
      margin: 0 auto;
    }
    .profile-image-preview, .profile-frame-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* 커스텀 모달 스타일 */
    .modal-themed-content { /* 모달 콘텐츠에 적용될 클래스 */
      background-color: #fefefe; /* 배경색은 흰색 유지 */
      padding: 20px;
      border: 1px solid #E0E0E0; /* 메인 페이지 테두리 색상과 유사하게 */
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      text-align: center;
      color: #2F4160; /* 기본 텍스트 색상 적용 */
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* 그림자 추가 */
    }
  </style>
</head>
<!-- 배경색 #f3f4f6, 기본 텍스트 색상 #2F4160 적용 -->
<body class="bg-[#f3f4f6] min-h-screen flex flex-col text-[#2F4160]">

<!-- 헤더 fragments 포함 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>

<!-- 헤더 아래에 사이드바와 메인 콘텐츠가 오도록 flex 컨테이너 추가 -->
<div class="flex-grow flex">
  <!-- 사이드바 fragments를 포함시킵니다. (테마 적용된 사이드바가 삽입될 것임) -->
  <div th:replace="~{fragments/sidebar :: sidebar}"></div>

  <div class="flex-grow p-8">
    <!-- max-w-3xl mx-auto 제거, shadow-md -> shadow-xl 로 변경하여 메인페이지와 통일 -->
    <div class="bg-white p-8 rounded-xl shadow-xl">

      <!-- 제목 색상 통일 -->
      <h1 class="text-3xl font-bold text-[#2F4160] mb-6">구매한 아이템</h1>

      <!-- 프로필 이미지 목록 -->
      <!-- H3 제목 색상 통일 -->
      <h3 class="text-xl font-semibold mt-6 mb-2 text-[#2F4160]">프로필 이미지 선택</h3>
      <div class="grid grid-cols-4 gap-2">
        <img th:each="img : ${profileImages}"
             th:src="@{'/uploads/images/' + ${img}}"
             th:attr="data-img=${img}"
             class="item-profile-img cursor-pointer border rounded-full hover:ring-2 ring-offset-2 ring-[#B5D0E3] w-20 h-20 object-cover transition-all duration-150 ease-in-out"
             onclick="selectProfileImage(this)">
      </div>

      <!-- 프레임 이미지 목록 -->
      <!-- H3 제목 색상 통일 -->
      <h3 class="text-xl font-semibold mt-6 mb-2 text-[#2F4160]">프레임 이미지 선택</h3>
      <div class="grid grid-cols-4 gap-2">
        <img th:each="frame : ${frameImages}"
             th:src="@{'/uploads/frames/' + ${frame}}"
             th:attr="data-frame=${frame}"
             class="item-frame-img cursor-pointer border hover:ring-2 ring-offset-2 ring-[#B5D0E3] w-20 h-20 object-cover transition-all duration-150 ease-in-out"
             onclick="selectFrameImage(this)">
      </div>

      <!-- 미리보기 -->
      <h3 class="text-xl font-semibold mt-6 mb-2 text-[#2F4160]">미리보기</h3>
      <div class="profile-container w-28 h-28 mx-auto mb-4">
        <img id="preview-profile" class="profile-image-preview rounded-full object-cover absolute top-1.5 left-1.5 w-[85%] h-[85%] z-0"/>
        <img id="preview-frame" class="profile-frame-preview pointer-events-none z-10"/>
      </div>

      <!-- 설정 버튼 -->
      <!-- 버튼 색상 #F29DA0, 호버 시 #2F4160, 텍스트 흰색 -->
      <button id="applyButton" class="bg-[#F29DA0] hover:bg-[#2F4160] text-white px-4 py-2 rounded-lg w-full transition-colors duration-200">
        설정하기
      </button>
    </div>
  </div>
</div>

<!-- 커스텀 모달 UI -->
<!-- 경고 모달 -->
<div id="alertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
  <div class="modal-themed-content">
    <p id="alertMessage" class="text-[#2F4160] mb-4"></p>
    <button id="alertCloseButton" class="bg-[#F29DA0] hover:bg-[#2F4160] text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
  </div>
</div>

<!-- 확인 모달 -->
<div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
  <div class="modal-themed-content">
    <p id="confirmMessage" class="text-[#2F4160] mb-4"></p>
    <div class="flex justify-around">
      <button id="confirmOkButton" class="bg-[#F29DA0] hover:bg-[#2F4160] text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
      <button id="confirmCancelButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">취소</button>
    </div>
  </div>
</div>

<script>
  let selectedProfileImage = null;
  let selectedFrameImage = null;

  // 모달 관련 요소 가져오기
  const alertModal = document.getElementById('alertModal');
  const alertMessage = document.getElementById('alertMessage');
  const alertCloseButton = document.getElementById('alertCloseButton');

  const confirmModal = document.getElementById('confirmModal');
  const confirmMessage = document.getElementById('confirmMessage');
  const confirmOkButton = document.getElementById('confirmOkButton');
  const confirmCancelButton = document.getElementById('confirmCancelButton');

  // 경고 모달 표시 함수
  function showAlert(message) {
    alertMessage.textContent = message;
    alertModal.classList.remove('hidden');
  }

  // 확인 모달 표시 함수 (Promise를 사용하여 동기적으로 동작)
  function showConfirm(message) {
    return new Promise(resolve => {
      confirmMessage.textContent = message;
      confirmModal.classList.remove('hidden');

      confirmOkButton.onclick = () => {
        confirmModal.classList.add('hidden');
        resolve(true);
      };

      confirmCancelButton.onclick = () => {
        confirmModal.classList.add('hidden');
        resolve(false);
      };
    });
  }

  // 선택된 아이템에 시각적 효과 추가
  function selectItem(selector, element, dataAttribute, value) {
    document.querySelectorAll(selector).forEach(item => {
      item.classList.remove('ring-4', 'ring-[#F29DA0]'); // 기존 파란색 링 제거, 코랄 핑크 링 제거
    });
    element.classList.add('ring-4', 'ring-[#F29DA0]'); // 코랄 핑크 링으로 변경
    return value;
  }

  // 프로필 이미지 선택
  function selectProfileImage(el) {
    selectedProfileImage = selectItem('.item-profile-img', el, 'data-img', el.getAttribute("data-img"));
    document.getElementById("preview-profile").src = "/uploads/images/" + selectedProfileImage;
  }

  // 프레임 이미지 선택
  function selectFrameImage(el) {
    selectedFrameImage = selectItem('.item-frame-img', el, 'data-frame', el.getAttribute("data-frame"));
    document.getElementById("preview-frame").src = "/uploads/frames/" + selectedFrameImage;
  }

  // 설정 버튼 클릭 이벤트 핸들러
  document.getElementById("applyButton").addEventListener('click', async () => {
    if (!selectedProfileImage && !selectedFrameImage) {
      showAlert("프로필 또는 프레임 이미지를 선택해주세요.");
      return;
    }

    const confirmed = await showConfirm("이대로 설정하시겠습니까?");

    if (confirmed) {
      fetch("/user/apply-setting", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          profileImage: selectedProfileImage,
          profileFrame: selectedFrameImage
        })
      }).then(res => {
        if (res.ok) {
          showAlert("프로필이 설정되었습니다!");
          // 모달이 닫힌 후 마이페이지로 이동
          alertCloseButton.onclick = () => {
              alertModal.classList.add('hidden');
              location.href = "/user/view";
          };
        } else {
          showAlert("설정 실패");
        }
      }).catch(error => {
          console.error('Error:', error);
          showAlert("설정 중 오류가 발생했습니다.");
      });
    }
  });

  // 경고 모달 닫기
  alertCloseButton.addEventListener('click', () => {
    alertModal.classList.add('hidden');
  });

</script>

<!-- 푸터 프래그먼트 삽입 -->
<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
