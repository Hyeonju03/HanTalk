<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보유 아이템 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기존 상점 페이지와 동일한 색상 팔레트 */
        .bg-main-dark { background-color: #2F4160; }
        .text-main-dark { color: #2F4160; }
        .bg-accent-pink { background-color: #F29DA0; }
        .text-accent-pink { color: #F29DA0; }
        .bg-soft-blue { background-color: #B5D0E3; }
        .text-soft-blue { color: #B5D0E3; }
        .hover-bg-soft-blue:hover { background-color: #B5D0E3; }
        .hover-text-accent-pink:hover { color: #F29DA0; }
        .container-custom { max-width: 1000px; }

        /* 페이지 전체 배경색을 순백색으로 변경 */
        body {
            background-color: #FFFFFF;
        }

        /* 프로필 이미지와 프레임이 겹쳐 보이도록 z-index 설정 */
        .profile-container {
          position: relative;
          width: 112px;
          height: 112px;
          margin: 0 auto;
        }
        /* 미리보기 영역의 반응형 크기 조정을 위한 스타일 */
        .profile-container.responsive {
          width: 15vw;
          height: 15vw;
          max-width: 180px;
          max-height: 180px;
        }
        @media (max-width: 640px) {
          .profile-container.responsive {
            width: 30vw;
            height: 30vw;
          }
        }
        .profile-image-preview, .profile-frame-preview {
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
        }
        .profile-image-preview {
          z-index: 0;
        }
        .profile-frame-preview {
          pointer-events: none;
          z-index: 1;
        }

        /* 커스텀 모달 스타일 */
        .modal-themed-content {
          background-color: #fefefe;
          padding: 20px;
          border: 1px solid #E0E0E0;
          width: 80%;
          max-width: 400px;
          border-radius: 8px;
          text-align: center;
          color: #2F4160;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* 로딩 스피너 */
        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          border-left-color: #fff;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* 아이템 카드 디자인 */
        .item-card {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 2px solid transparent;
        }

        .item-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .item-card.selected {
            border-color: #F29DA0;
            box-shadow: 0 0 15px #F29DA0;
            transform: scale(1.05);
        }

        .item-card-image {
            transition: transform 0.5s ease-in-out;
            padding: 1rem;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 설정하기 버튼 애니메이션 */
        .apply-btn {
            background-image: linear-gradient(to right, #F29DA0 0%, #B5D0E3 100%);
            transition: all 0.5s ease;
            background-size: 200% auto;
        }
        .apply-btn:hover {
            background-position: right center;
            box-shadow: 0 8px 24px rgba(242, 157, 160, 0.4);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans text-main-dark">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="flex-grow flex justify-center p-8 space-x-8">

    <div th:replace="~{fragments/mypageSidebar :: mypageSidebar}"></div>

    <div class="container-custom w-full">
        <div class="bg-white/80 backdrop-blur-md p-8 rounded-3xl shadow-2xl">

            <h1 class="text-3xl font-bold text-main-dark mb-6 text-center">보유 아이템</h1>

            <!-- 연한 회색 구분선 추가 -->
            <hr class="border-t border-gray-200 my-8">

            <!-- 메인 컨텐츠를 나란히 배치하기 위한 flex 컨테이너, 좌우 간격 축소 -->
            <div class="flex flex-col md:flex-row justify-between md:space-x-4">

                <!-- 좌측: 아이템 선택 섹션 -->
                <div class="w-full md:w-2/3">
                    <!-- 탭 메뉴 -->
                    <div class="flex justify-center md:justify-start mb-6">
                        <button id="profile-tab" class="p-4 rounded-tl-xl rounded-bl-xl font-bold transition-all duration-300 transform scale-100 hover:scale-105" style="background-color: #B5D0E3; color: #2F4160;">
                            프로필 이미지
                        </button>
                        <button id="frame-tab" class="p-4 rounded-tr-xl rounded-br-xl font-bold transition-all duration-300 transform scale-100 hover:scale-105" style="background-color: #fff; color: #B5D0E3;">
                            프레임
                        </button>
                    </div>

                    <!-- 프로필 이미지 선택 섹션 -->
                    <div id="profile-items-section">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center md:text-left">프로필 이미지 선택</h3>
                        <div class="flex flex-wrap justify-center md:justify-start gap-8">
                            <div th:each="img : ${profileImages}"
                                 class="w-24 h-24 aspect-square rounded-full overflow-hidden shadow-lg item-card">
                                <img th:src="@{'/uploads/images/' + ${img}}"
                                     th:attr="data-img=${img}"
                                     class="item-profile-img cursor-pointer object-cover w-full h-full item-card-image"
                                     onclick="selectProfileImage(this)">
                            </div>
                        </div>
                    </div>

                    <!-- 프레임 이미지 선택 섹션 -->
                    <div id="frame-items-section" class="hidden">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center md:text-left">프레임 이미지 선택</h3>
                        <div class="flex flex-wrap justify-center md:justify-start gap-8">
                            <div th:each="frame : ${frameImages}"
                                 class="w-24 h-24 aspect-square rounded-xl overflow-hidden shadow-lg item-card">
                                <img th:src="@{'/uploads/frames/' + ${frame}}"
                                     th:attr="data-frame=${frame}"
                                     class="item-frame-img cursor-pointer object-cover w-full h-full item-card-image"
                                     onclick="selectFrameImage(this)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 우측: 미리보기 및 설정 섹션 -->
                <div class="w-full md:w-1/3 mt-8 md:mt-0 flex flex-col items-center">
                    <!-- 미리보기 영역을 카드 형식으로 변경 -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 w-full mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center">미리보기</h3>
                        <div class="profile-container mx-auto responsive">
                            <img id="preview-profile" class="profile-image-preview rounded-full object-cover"/>
                            <img id="preview-frame" class="profile-frame-preview"/>
                        </div>
                    </div>

                    <div class="flex justify-center mt-8 w-full">
                        <button id="applyButton"
                                class="apply-btn text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all duration-300 flex items-center justify-center">
                            <span id="button-text">설정하기</span>
                            <div id="button-spinner" class="spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="py-4 text-gray-500 text-center text-sm bg-gray-100" th:replace="~{fragments/footer :: footerFragment}"></div>

<!-- 커스텀 모달들 -->
<div id="alertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="alertMessage" class="text-main-dark mb-4"></p>
        <button id="alertCloseButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
    </div>
</div>

<div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="confirmMessage" class="text-main-dark mb-4"></p>
        <div class="flex justify-around">
            <button id="confirmOkButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
            <button id="confirmCancelButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">취소</button>
        </div>
    </div>
</div>

<script>
    // 전역 변수 초기화
    let selectedProfileImage = null;
    let selectedFrameImage = null;

    // DOM 요소 캐싱
    const profileTab = document.getElementById('profile-tab');
    const frameTab = document.getElementById('frame-tab');
    const profileSection = document.getElementById('profile-items-section');
    const frameSection = document.getElementById('frame-items-section');

    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const alertCloseButton = document.getElementById('alertCloseButton');

    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmOkButton = document.getElementById('confirmOkButton');
    const confirmCancelButton = document.getElementById('confirmCancelButton');

    const applyButton = document.getElementById('applyButton');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');

    /**
     * 커스텀 알림 모달을 표시합니다.
     * @param {string} message - 표시할 메시지
     */
    function showAlert(message) {
      alertMessage.textContent = message;
      alertModal.classList.remove('hidden');
    }

    /**
     * 커스텀 확인 모달을 표시하고 사용자의 응답을 Promise로 반환합니다.
     * @param {string} message - 표시할 메시지
     * @returns {Promise<boolean>} 사용자가 확인을 누르면 true, 취소를 누르면 false를 반환
     */
    function showConfirm(message) {
      return new Promise(resolve => {
        confirmMessage.textContent = message;
        confirmModal.classList.remove('hidden');

        confirmOkButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(true);
        };

        confirmCancelButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(false);
        };
      });
    }

    /**
     * 선택된 아이템의 시각적 하이라이트를 업데이트합니다.
     * @param {string} selector - 모든 아이템을 선택하기 위한 CSS 선택자
     * @param {HTMLElement} element - 현재 선택된 아이템 요소
     * @param {string} value - 선택된 아이템의 값 (이미지 URL)
     * @returns {string} 선택된 아이템의 값
     */
    function selectItem(selector, element, value) {
      // 동일 카테고리의 모든 아이템에서 'selected' 클래스 제거
      document.querySelectorAll(selector).forEach(item => {
        item.closest('.item-card').classList.remove('selected');
      });
      // 현재 선택된 아이템에 'selected' 클래스 추가
      element.closest('.item-card').classList.add('selected');
      return value;
    }

    /**
     * 프로필 이미지를 선택하고 미리보기를 업데이트합니다.
     * @param {HTMLElement} el - 클릭된 프로필 이미지 요소
     */
    function selectProfileImage(el) {
      const imageUrl = el.getAttribute("data-img");
      selectedProfileImage = selectItem('.item-profile-img', el, imageUrl);
      document.getElementById("preview-profile").src = `/uploads/images/${selectedProfileImage}`;
    }

    /**
     * 프레임 이미지를 선택하고 미리보기를 업데이트합니다.
     * @param {HTMLElement} el - 클릭된 프레임 이미지 요소
     */
    function selectFrameImage(el) {
      const imageUrl = el.getAttribute("data-frame");
      selectedFrameImage = selectItem('.item-frame-img', el, imageUrl);
      document.getElementById("preview-frame").src = `/uploads/frames/${selectedFrameImage}`;
    }

    // 탭 전환 기능
    function switchTab(tabId) {
        // 탭 버튼 스타일 업데이트
        profileTab.style.backgroundColor = tabId === 'profile' ? '#B5D0E3' : '#fff';
        profileTab.style.color = tabId === 'profile' ? '#2F4160' : '#B5D0E3';
        frameTab.style.backgroundColor = tabId === 'frame' ? '#B5D0E3' : '#fff';
        frameTab.style.color = tabId === 'frame' ? '#2F4160' : '#B5D0E3';

        // 섹션 가시성 업데이트
        profileSection.classList.toggle('hidden', tabId !== 'profile');
        frameSection.classList.toggle('hidden', tabId !== 'frame');
    }

    profileTab.addEventListener('click', () => switchTab('profile'));
    frameTab.addEventListener('click', () => switchTab('frame'));

    // 설정하기 버튼 클릭 이벤트
    applyButton.addEventListener('click', async () => {
      if (applyButton.disabled) {
        return;
      }

      if (!selectedProfileImage && !selectedFrameImage) {
        showAlert("프로필 또는 프레임 이미지를 선택해주세요.");
        return;
      }

      const confirmed = await showConfirm("이대로 설정하시겠습니까?");

      if (confirmed) {
        // 로딩 상태 시작
        applyButton.disabled = true;
        buttonText.classList.add('hidden');
        buttonSpinner.classList.remove('hidden');

        try {
          const res = await fetch("/user/apply-setting", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              profileImage: selectedProfileImage,
              profileFrame: selectedFrameImage
            })
          });

          if (res.ok) {
            showAlert("프로필이 성공적으로 설정되었습니다!🎉");
            alertCloseButton.onclick = () => {
                alertModal.classList.add('hidden');
                location.href = "/user/view";
            };
          } else {
            showAlert("설정 실패: 서버 오류가 발생했습니다.");
          }
        } catch (error) {
            console.error('Error:', error);
            showAlert("설정 중 오류가 발생했습니다. 네트워크를 확인해주세요.");
        } finally {
          // 로딩 상태 종료
          applyButton.disabled = false;
          buttonText.classList.remove('hidden');
          buttonSpinner.classList.add('hidden');
        }
      }
    });

    // 알림 모달 닫기 버튼 이벤트
    alertCloseButton.addEventListener('click', () => {
      alertModal.classList.add('hidden');
    });

    // 페이지 로드 시 초기 선택 아이템 설정
    document.addEventListener('DOMContentLoaded', () => {
        // 기존 코드의 문제점: 모든 아이템에 ring을 적용했음
        // 수정: 서버에서 초기 설정된 아이템 정보를 받아와서 해당 아이템에만 selected 클래스를 적용하도록 변경
        // 예시: th:attr="data-is-selected=${img == '기본프로필.png' ? 'true' : 'false'}"
        const initialProfileEl = document.querySelector('.item-profile-img[data-is-selected="true"]');
        if (initialProfileEl) {
            selectProfileImage(initialProfileEl);
        }
        const initialFrameEl = document.querySelector('.item-frame-img[data-is-selected="true"]');
        if (initialFrameEl) {
            selectFrameImage(initialFrameEl);
        }

        // 초기 로드 시 탭을 프로필 탭으로 설정
        switchTab('profile');
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>