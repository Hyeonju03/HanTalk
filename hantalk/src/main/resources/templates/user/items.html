<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ìœ  ì•„ì´í…œ ëª©ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ê¸°ì¡´ ìƒì  í˜ì´ì§€ì™€ ë™ì¼í•œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
        .bg-main-dark { background-color: #2F4160; }
        .text-main-dark { color: #2F4160; }
        .bg-accent-pink { background-color: #F29DA0; }
        .text-accent-pink { color: #F29DA0; }
        .bg-soft-blue { background-color: #B5D0E3; }
        .text-soft-blue { color: #B5D0E3; }
        .hover-bg-soft-blue:hover { background-color: #B5D0E3; }
        .hover-text-accent-pink:hover { color: #F29DA0; }
        .container-custom { max-width: 1000px; }

        /* í˜ì´ì§€ ì „ì²´ ë°°ê²½ìƒ‰ì„ ìˆœë°±ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        body {
            background-color: #FFFFFF;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ì™€ í”„ë ˆì„ì´ ê²¹ì³ ë³´ì´ë„ë¡ z-index ì„¤ì • */
        .profile-container {
          position: relative;
          width: 112px;
          height: 112px;
          margin: 0 auto;
        }
        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì˜ ë°˜ì‘í˜• í¬ê¸° ì¡°ì •ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .profile-container.responsive {
          width: 15vw;
          height: 15vw;
          max-width: 180px;
          max-height: 180px;
        }
        @media (max-width: 640px) {
          .profile-container.responsive {
            width: 30vw;
            height: 30vw;
          }
        }
        .profile-image-preview, .profile-frame-preview {
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
        }
        .profile-image-preview {
          z-index: 0;
        }
        .profile-frame-preview {
          pointer-events: none;
          z-index: 1;
        }

        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-themed-content {
          background-color: #fefefe;
          padding: 20px;
          border: 1px solid #E0E0E0;
          width: 80%;
          max-width: 400px;
          border-radius: 8px;
          text-align: center;
          color: #2F4160;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          border-left-color: #fff;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* ì•„ì´í…œ ì¹´ë“œ ë””ìì¸ */
        .item-card {
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 2px solid transparent;
        }

        .item-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .item-card.selected {
            border-color: #F29DA0;
            box-shadow: 0 0 15px #F29DA0;
            transform: scale(1.05);
        }

        .item-card-image {
            transition: transform 0.5s ease-in-out;
            padding: 1rem;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ì„¤ì •í•˜ê¸° ë²„íŠ¼ ì• ë‹ˆë©”ì´ì…˜ */
        .apply-btn {
            background-image: linear-gradient(to right, #F29DA0 0%, #B5D0E3 100%);
            transition: all 0.5s ease;
            background-size: 200% auto;
        }
        .apply-btn:hover {
            background-position: right center;
            box-shadow: 0 8px 24px rgba(242, 157, 160, 0.4);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans text-main-dark">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="flex-grow flex justify-center p-8 space-x-8">

    <div th:replace="~{fragments/mypageSidebar :: mypageSidebar}"></div>

    <div class="container-custom w-full">
        <div class="bg-white/80 backdrop-blur-md p-8 rounded-3xl shadow-2xl">

            <h1 class="text-3xl font-bold text-main-dark mb-6 text-center">ë³´ìœ  ì•„ì´í…œ</h1>

            <!-- ì—°í•œ íšŒìƒ‰ êµ¬ë¶„ì„  ì¶”ê°€ -->
            <hr class="border-t border-gray-200 my-8">

            <!-- ë©”ì¸ ì»¨í…ì¸ ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜í•˜ê¸° ìœ„í•œ flex ì»¨í…Œì´ë„ˆ, ì¢Œìš° ê°„ê²© ì¶•ì†Œ -->
            <div class="flex flex-col md:flex-row justify-between md:space-x-4">

                <!-- ì¢Œì¸¡: ì•„ì´í…œ ì„ íƒ ì„¹ì…˜ -->
                <div class="w-full md:w-2/3">
                    <!-- íƒ­ ë©”ë‰´ -->
                    <div class="flex justify-center md:justify-start mb-6">
                        <button id="profile-tab" class="p-4 rounded-tl-xl rounded-bl-xl font-bold transition-all duration-300 transform scale-100 hover:scale-105" style="background-color: #B5D0E3; color: #2F4160;">
                            í”„ë¡œí•„ ì´ë¯¸ì§€
                        </button>
                        <button id="frame-tab" class="p-4 rounded-tr-xl rounded-br-xl font-bold transition-all duration-300 transform scale-100 hover:scale-105" style="background-color: #fff; color: #B5D0E3;">
                            í”„ë ˆì„
                        </button>
                    </div>

                    <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ ì„¹ì…˜ -->
                    <div id="profile-items-section">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center md:text-left">í”„ë¡œí•„ ì´ë¯¸ì§€ ì„ íƒ</h3>
                        <div class="flex flex-wrap justify-center md:justify-start gap-8">
                            <div th:each="img : ${profileImages}"
                                 class="w-24 h-24 aspect-square rounded-full overflow-hidden shadow-lg item-card">
                                <img th:src="@{'/uploads/images/' + ${img}}"
                                     th:attr="data-img=${img}"
                                     class="item-profile-img cursor-pointer object-cover w-full h-full item-card-image"
                                     onclick="selectProfileImage(this)">
                            </div>
                        </div>
                    </div>

                    <!-- í”„ë ˆì„ ì´ë¯¸ì§€ ì„ íƒ ì„¹ì…˜ -->
                    <div id="frame-items-section" class="hidden">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center md:text-left">í”„ë ˆì„ ì´ë¯¸ì§€ ì„ íƒ</h3>
                        <div class="flex flex-wrap justify-center md:justify-start gap-8">
                            <div th:each="frame : ${frameImages}"
                                 class="w-24 h-24 aspect-square rounded-xl overflow-hidden shadow-lg item-card">
                                <img th:src="@{'/uploads/frames/' + ${frame}}"
                                     th:attr="data-frame=${frame}"
                                     class="item-frame-img cursor-pointer object-cover w-full h-full item-card-image"
                                     onclick="selectFrameImage(this)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìš°ì¸¡: ë¯¸ë¦¬ë³´ê¸° ë° ì„¤ì • ì„¹ì…˜ -->
                <div class="w-full md:w-1/3 mt-8 md:mt-0 flex flex-col items-center">
                    <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ì„ ì¹´ë“œ í˜•ì‹ìœ¼ë¡œ ë³€ê²½ -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 w-full mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-main-dark text-center">ë¯¸ë¦¬ë³´ê¸°</h3>
                        <div class="profile-container mx-auto responsive">
                            <img id="preview-profile" class="profile-image-preview rounded-full object-cover"/>
                            <img id="preview-frame" class="profile-frame-preview"/>
                        </div>
                    </div>

                    <div class="flex justify-center mt-8 w-full">
                        <button id="applyButton"
                                class="apply-btn text-white px-8 py-3 rounded-full font-bold shadow-lg transition-all duration-300 flex items-center justify-center">
                            <span id="button-text">ì„¤ì •í•˜ê¸°</span>
                            <div id="button-spinner" class="spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="py-4 text-gray-500 text-center text-sm bg-gray-100" th:replace="~{fragments/footer :: footerFragment}"></div>

<!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ë“¤ -->
<div id="alertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="alertMessage" class="text-main-dark mb-4"></p>
        <button id="alertCloseButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">í™•ì¸</button>
    </div>
</div>

<div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="confirmMessage" class="text-main-dark mb-4"></p>
        <div class="flex justify-around">
            <button id="confirmOkButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">í™•ì¸</button>
            <button id="confirmCancelButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    let selectedProfileImage = null;
    let selectedFrameImage = null;

    // DOM ìš”ì†Œ ìºì‹±
    const profileTab = document.getElementById('profile-tab');
    const frameTab = document.getElementById('frame-tab');
    const profileSection = document.getElementById('profile-items-section');
    const frameSection = document.getElementById('frame-items-section');

    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const alertCloseButton = document.getElementById('alertCloseButton');

    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmOkButton = document.getElementById('confirmOkButton');
    const confirmCancelButton = document.getElementById('confirmCancelButton');

    const applyButton = document.getElementById('applyButton');
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');

    /**
     * ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     */
    function showAlert(message) {
      alertMessage.textContent = message;
      alertModal.classList.remove('hidden');
    }

    /**
     * ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  ì‚¬ìš©ìì˜ ì‘ë‹µì„ Promiseë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
     * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
     * @returns {Promise<boolean>} ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆ„ë¥´ë©´ true, ì·¨ì†Œë¥¼ ëˆ„ë¥´ë©´ falseë¥¼ ë°˜í™˜
     */
    function showConfirm(message) {
      return new Promise(resolve => {
        confirmMessage.textContent = message;
        confirmModal.classList.remove('hidden');

        confirmOkButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(true);
        };

        confirmCancelButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(false);
        };
      });
    }

    /**
     * ì„ íƒëœ ì•„ì´í…œì˜ ì‹œê°ì  í•˜ì´ë¼ì´íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {string} selector - ëª¨ë“  ì•„ì´í…œì„ ì„ íƒí•˜ê¸° ìœ„í•œ CSS ì„ íƒì
     * @param {HTMLElement} element - í˜„ì¬ ì„ íƒëœ ì•„ì´í…œ ìš”ì†Œ
     * @param {string} value - ì„ íƒëœ ì•„ì´í…œì˜ ê°’ (ì´ë¯¸ì§€ URL)
     * @returns {string} ì„ íƒëœ ì•„ì´í…œì˜ ê°’
     */
    function selectItem(selector, element, value) {
      // ë™ì¼ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ì•„ì´í…œì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
      document.querySelectorAll(selector).forEach(item => {
        item.closest('.item-card').classList.remove('selected');
      });
      // í˜„ì¬ ì„ íƒëœ ì•„ì´í…œì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
      element.closest('.item-card').classList.add('selected');
      return value;
    }

    /**
     * í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLElement} el - í´ë¦­ëœ í”„ë¡œí•„ ì´ë¯¸ì§€ ìš”ì†Œ
     */
    function selectProfileImage(el) {
      const imageUrl = el.getAttribute("data-img");
      selectedProfileImage = selectItem('.item-profile-img', el, imageUrl);
      document.getElementById("preview-profile").src = `/uploads/images/${selectedProfileImage}`;
    }

    /**
     * í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê³  ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {HTMLElement} el - í´ë¦­ëœ í”„ë ˆì„ ì´ë¯¸ì§€ ìš”ì†Œ
     */
    function selectFrameImage(el) {
      const imageUrl = el.getAttribute("data-frame");
      selectedFrameImage = selectItem('.item-frame-img', el, imageUrl);
      document.getElementById("preview-frame").src = `/uploads/frames/${selectedFrameImage}`;
    }

    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    function switchTab(tabId) {
        // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        profileTab.style.backgroundColor = tabId === 'profile' ? '#B5D0E3' : '#fff';
        profileTab.style.color = tabId === 'profile' ? '#2F4160' : '#B5D0E3';
        frameTab.style.backgroundColor = tabId === 'frame' ? '#B5D0E3' : '#fff';
        frameTab.style.color = tabId === 'frame' ? '#2F4160' : '#B5D0E3';

        // ì„¹ì…˜ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
        profileSection.classList.toggle('hidden', tabId !== 'profile');
        frameSection.classList.toggle('hidden', tabId !== 'frame');
    }

    profileTab.addEventListener('click', () => switchTab('profile'));
    frameTab.addEventListener('click', () => switchTab('frame'));

    // ì„¤ì •í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    applyButton.addEventListener('click', async () => {
      if (applyButton.disabled) {
        return;
      }

      if (!selectedProfileImage && !selectedFrameImage) {
        showAlert("í”„ë¡œí•„ ë˜ëŠ” í”„ë ˆì„ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const confirmed = await showConfirm("ì´ëŒ€ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");

      if (confirmed) {
        // ë¡œë”© ìƒíƒœ ì‹œì‘
        applyButton.disabled = true;
        buttonText.classList.add('hidden');
        buttonSpinner.classList.remove('hidden');

        try {
          const res = await fetch("/user/apply-setting", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              profileImage: selectedProfileImage,
              profileFrame: selectedFrameImage
            })
          });

          if (res.ok) {
            showAlert("í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!ğŸ‰");
            alertCloseButton.onclick = () => {
                alertModal.classList.add('hidden');
                location.href = "/user/view";
            };
          } else {
            showAlert("ì„¤ì • ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (error) {
            console.error('Error:', error);
            showAlert("ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        } finally {
          // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
          applyButton.disabled = false;
          buttonText.classList.remove('hidden');
          buttonSpinner.classList.add('hidden');
        }
      }
    });

    // ì•Œë¦¼ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
    alertCloseButton.addEventListener('click', () => {
      alertModal.classList.add('hidden');
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì„ íƒ ì•„ì´í…œ ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        // ê¸°ì¡´ ì½”ë“œì˜ ë¬¸ì œì : ëª¨ë“  ì•„ì´í…œì— ringì„ ì ìš©í–ˆìŒ
        // ìˆ˜ì •: ì„œë²„ì—ì„œ ì´ˆê¸° ì„¤ì •ëœ ì•„ì´í…œ ì •ë³´ë¥¼ ë°›ì•„ì™€ì„œ í•´ë‹¹ ì•„ì´í…œì—ë§Œ selected í´ë˜ìŠ¤ë¥¼ ì ìš©í•˜ë„ë¡ ë³€ê²½
        // ì˜ˆì‹œ: th:attr="data-is-selected=${img == 'ê¸°ë³¸í”„ë¡œí•„.png' ? 'true' : 'false'}"
        const initialProfileEl = document.querySelector('.item-profile-img[data-is-selected="true"]');
        if (initialProfileEl) {
            selectProfileImage(initialProfileEl);
        }
        const initialFrameEl = document.querySelector('.item-frame-img[data-is-selected="true"]');
        if (initialFrameEl) {
            selectFrameImage(initialFrameEl);
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ íƒ­ì„ í”„ë¡œí•„ íƒ­ìœ¼ë¡œ ì„¤ì •
        switchTab('profile');
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>