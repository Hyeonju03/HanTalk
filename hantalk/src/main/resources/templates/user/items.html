<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보유 아이템 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-main-dark { background-color: #2F4160; }
        .text-main-dark { color: #2F4160; }
        .bg-accent-pink { background-color: #F29DA0; }
        .text-accent-pink { color: #F29DA0; }
        .bg-soft-blue { background-color: #B5D0E3; }
        .text-soft-blue { color: #B5D0E3; }
        .hover-bg-soft-blue:hover { background-color: #B5D0E3; }
        .hover-text-accent-pink:hover { color: #F29DA0; }
        .container-custom { max-width: 1000px; }

        /* 프로필 이미지와 프레임이 겹쳐 보이도록 z-index 설정 */
        .profile-container {
          position: relative;
          /* 기본 크기 설정, 추후 반응형 클래스로 오버라이드됨 */
          width: 112px;
          height: 112px;
          margin: 0 auto;
        }
        /* 미리보기 영역의 반응형 크기 조정을 위한 스타일 */
        .profile-container.responsive {
          width: 15vw; /* 뷰포트 너비의 15% */
          height: 15vw; /* 뷰포트 너비의 15% (정사각형 비율 유지) */
          max-width: 180px; /* 최대 크기 제한 */
          max-height: 180px;
        }
        @media (max-width: 640px) {
          .profile-container.responsive {
            width: 30vw;
            height: 30vw;
          }
        }
        .profile-image-preview, .profile-frame-preview {
          position: absolute;
          width: 100%;
          height: 100%;
          top: 0;
          left: 0;
        }
        .profile-image-preview {
          z-index: 0;
        }
        .profile-frame-preview {
          pointer-events: none;
          z-index: 1;
        }

        /* 커스텀 모달 스타일 */
        .modal-themed-content {
          background-color: #fefefe;
          padding: 20px;
          border: 1px solid #E0E0E0;
          width: 80%;
          max-width: 400px;
          border-radius: 8px;
          text-align: center;
          color: #2F4160;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 font-sans text-main-dark">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="flex-grow flex justify-center p-8 space-x-8">

    <div th:replace="~{fragments/mypageSidebar :: mypageSidebar}"></div>

    <div class="container-custom w-full">
        <div class="bg-white p-8 rounded-xl shadow-xl">

            <h1 class="text-3xl font-bold text-main-dark mb-6 text-center">구매한 아이템</h1>

            <h3 class="text-xl font-semibold mt-6 mb-2 text-main-dark text-center">프로필 이미지 선택</h3>
            <div class="flex flex-wrap justify-center gap-8">
                <div th:each="img : ${profileImages}" class="relative w-24 h-24 aspect-square">
                    <img th:src="@{'/uploads/images/' + ${img}}"
                         th:attr="data-img=${img}"
                         class="item-profile-img cursor-pointer border rounded-full hover:ring-2 ring-offset-2 ring-soft-blue object-cover transition-all duration-150 ease-in-out w-full h-full"
                         onclick="selectProfileImage(this)">
                </div>
            </div>

            <h3 class="text-xl font-semibold mt-6 mb-2 text-main-dark text-center">프레임 이미지 선택</h3>
            <div class="flex flex-wrap justify-center gap-8">
                <div th:each="frame : ${frameImages}" class="relative w-24 h-24 aspect-square">
                    <img th:src="@{'/uploads/frames/' + ${frame}}"
                         th:attr="data-frame=${frame}"
                         class="item-frame-img cursor-pointer border hover:ring-2 ring-offset-2 ring-soft-blue object-cover transition-all duration-150 ease-in-out w-full h-full"
                         onclick="selectFrameImage(this)">
                </div>
            </div>

            <h3 class="text-xl font-semibold mt-6 mb-2 text-main-dark text-center">미리보기</h3>
            <div class="profile-container mx-auto mb-4 responsive">
                <img id="preview-profile" class="profile-image-preview rounded-full object-cover"/>
                <img id="preview-frame" class="profile-frame-preview"/>
            </div>

            <div class="flex justify-center mt-4">
                <button id="applyButton" class="bg-accent-pink hover:bg-main-dark text-white px-4 py-2 rounded-lg w-auto max-w-xs transition-colors duration-200">
                    설정하기
                </button>
            </div>
        </div>
    </div>
</main>

<div class="py-4 text-gray-500 text-center text-sm bg-gray-100" th:replace="~{fragments/footer :: footerFragment}"></div>

<div id="alertModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="alertMessage" class="text-main-dark mb-4"></p>
        <button id="alertCloseButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
    </div>
</div>

<div id="confirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
    <div class="modal-themed-content">
        <p id="confirmMessage" class="text-main-dark mb-4"></p>
        <div class="flex justify-around">
            <button id="confirmOkButton" class="bg-accent-pink hover:bg-main-dark text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">확인</button>
            <button id="confirmCancelButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">취소</button>
        </div>
    </div>
</div>

<script>
    let selectedProfileImage = null;
    let selectedFrameImage = null;

    const alertModal = document.getElementById('alertModal');
    const alertMessage = document.getElementById('alertMessage');
    const alertCloseButton = document.getElementById('alertCloseButton');

    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmOkButton = document.getElementById('confirmOkButton');
    const confirmCancelButton = document.getElementById('confirmCancelButton');

    function showAlert(message) {
      alertMessage.textContent = message;
      alertModal.classList.remove('hidden');
    }

    function showConfirm(message) {
      return new Promise(resolve => {
        confirmMessage.textContent = message;
        confirmModal.classList.remove('hidden');

        confirmOkButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(true);
        };

        confirmCancelButton.onclick = () => {
          confirmModal.classList.add('hidden');
          resolve(false);
        };
      });
    }

    function selectItem(selector, element, dataAttribute, value) {
      document.querySelectorAll(selector).forEach(item => {
        item.closest('.relative').classList.remove('ring-4', 'ring-accent-pink');
      });
      element.closest('.relative').classList.add('ring-4', 'ring-accent-pink');
      return value;
    }

    function selectProfileImage(el) {
      selectedProfileImage = selectItem('.item-profile-img', el, 'data-img', el.getAttribute("data-img"));
      document.getElementById("preview-profile").src = "/uploads/images/" + selectedProfileImage;
    }

    function selectFrameImage(el) {
      selectedFrameImage = selectItem('.item-frame-img', el, 'data-frame', el.getAttribute("data-frame"));
      document.getElementById("preview-frame").src = "/uploads/frames/" + selectedFrameImage;
    }

    document.getElementById("applyButton").addEventListener('click', async () => {
      if (!selectedProfileImage && !selectedFrameImage) {
        showAlert("프로필 또는 프레임 이미지를 선택해주세요.");
        return;
      }

      const confirmed = await showConfirm("이대로 설정하시겠습니까?");

      if (confirmed) {
        fetch("/user/apply-setting", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            profileImage: selectedProfileImage,
            profileFrame: selectedFrameImage
          })
        }).then(res => {
          if (res.ok) {
            showAlert("프로필이 설정되었습니다!");
            alertCloseButton.onclick = () => {
                alertModal.classList.add('hidden');
                location.href = "/user/view";
            };
          } else {
            showAlert("설정 실패");
          }
        }).catch(error => {
            console.error('Error:', error);
            showAlert("설정 중 오류가 발생했습니다.");
        });
      }
    });

    alertCloseButton.addEventListener('click', () => {
      alertModal.classList.add('hidden');
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>