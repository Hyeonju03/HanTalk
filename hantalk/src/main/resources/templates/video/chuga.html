<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 강의 업로드</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    /* Nanum Gothic 폰트 설정 */
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap');
    body {
        font-family: 'Nanum Gothic', sans-serif;
    }

    /* Custom animation for message box */
    @keyframes fadeOut {
        0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    }
  </style>
</head>
<body class="bg-[#f3f4f6] text-[#2F4160] min-h-screen flex flex-col items-center p-8">

<!-- Thymeleaf fragments/header :: headerFragment 가 없으므로 주석 처리 (HTML 단독 실행용) -->
<!-- <div th:replace="~{fragments/header :: headerFragment}"></div> -->

<div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg w-full">
  <h1 class="text-3xl font-bold text-center text-[#2F4160] mb-8">🎬 영상 업로드</h1>

  <form id="uploadForm" th:action="@{/video/admin/chugaProc}" method="post" enctype="multipart/form-data"
        class="space-y-6">

    <div class="flex flex-col">
      <label for="title" class="text-lg font-semibold mb-2">제목:</label>
      <input type="text" name="title" id="title" required
             class="border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-[#B5D0E3] text-[#2F4160]"/>
    </div>

    <div class="flex flex-col">
      <label for="content" class="text-lg font-semibold mb-2">설명:</label>
      <textarea name="content" id="content" required rows="5"
                class="border border-gray-300 rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-[#B5D0E3] text-[#2F4160]"></textarea>
    </div>

    <div class="flex flex-col">
      <label for="fileInput" class="text-lg font-semibold mb-2">영상 파일 (MP4만 가능):</label>
      <input type="file" name="file" id="fileInput" accept="video/mp4" required
             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0 file:text-sm file:font-semibold
                    file:bg-[#4B4B4B] file:text-white hover:file:bg-[#2F4160] hover:file:text-white transition-colors duration-300 cursor-pointer"/>
      <span id="fileCheckResult" class="text-red-500 text-sm mt-2"></span>
    </div>

    <!-- 업로드 버튼을 중앙 정렬하는 div 추가 -->
    <div class="text-center">
      <button type="submit" id="submitBtn"
              class="inline-flex items-center justify-center bg-[#4B4B4B] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[#2F4160] transition duration-300">
        <i class="fas fa-upload mr-2"></i> 업로드
      </button>
    </div>
  </form>

  <div class="mt-8 text-center">
    <a th:href="@{/video/admin/list}"
       class="inline-flex items-center bg-gray-200 text-gray-700 py-2 px-6 rounded-lg shadow-md hover:bg-[#2F4160] hover:text-white transition-colors duration-300">
      <i class="fas fa-arrow-left mr-2"></i> 목록으로
    </a>
  </div>
</div>

<script>
  // Custom message box function
  function showCustomMessage(message, type = 'info') {
      const messageBox = document.createElement('div');
      messageBox.textContent = message;
      let bgColor = '#2F4160'; // Default: Dark Navy
      let textColor = 'white';

      if (type === 'error') {
          bgColor = '#F29DA0'; // Coral Pink for errors
      } else if (type === 'success') {
          bgColor = '#B5D0E3'; // Soft Sky Blue for success
          textColor = '#2F4160'; // Dark Navy for text on success
      }

      messageBox.style.cssText = `
          position: fixed;
          top: 20%;
          left: 50%;
          transform: translate(-50%, -50%);
          background-color: ${bgColor};
          color: ${textColor};
          padding: 15px 30px;
          border-radius: 8px;
          z-index: 1000;
          font-size: 1.1em;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          animation: fadeOut 3s forwards;
      `;
      document.body.appendChild(messageBox);

      // Ensure the fadeOut keyframes are available (add only once)
      if (!document.querySelector('style#fadeOutKeyframes')) {
          const styleSheet = document.createElement("style");
          styleSheet.id = "fadeOutKeyframes"; // Add an ID to prevent duplicates
          styleSheet.type = "text/css";
          styleSheet.innerText = `
              @keyframes fadeOut {
                  0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                  100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
              }
          `;
          document.head.appendChild(styleSheet);
      }

      setTimeout(() => {
          messageBox.remove();
      }, 3000);
  }

  $(document).ready(function () {
   let isDuplicate = false;

   $('#fileInput').on('change', function () {
      const file = this.files[0];
      if (!file) {
          $('#fileCheckResult').text(''); // 파일 선택 취소 시 메시지 초기화
          $('#submitBtn').prop('disabled', false); // 버튼 활성화
          isDuplicate = false;
          return;
      }

      const filename = file.name;

      $.ajax({
        url: '/video/admin/check-filename',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ filename: filename }),
        success: function(response) {
          if(response === true) {
            $('#fileCheckResult').text('이미 동일한 영상이 업로드되어 있습니다.');
            $('#submitBtn').prop('disabled', true);
            isDuplicate = true;
          } else {
            $('#fileCheckResult').text('');
            $('#submitBtn').prop('disabled', false);
            isDuplicate = false;
          }
        },
        error: function() {
          $('#fileCheckResult').text('서버 오류로 중복 체크 실패');
          $('#submitBtn').prop('disabled', true);
          isDuplicate = true;
        }
      });
    });

   $('#uploadForm').on('submit', function (e) {
     if (isDuplicate) {
       e.preventDefault();
       showCustomMessage('중복된 파일명으로 업로드할 수 없습니다.', 'error'); // alert 대신 showCustomMessage 사용
     }
   });
 });

</script>
<!-- Thymeleaf fragments/footer :: footerFragment 가 없으므로 주석 처리 (HTML 단독 실행용) -->
<!-- <div th:replace="~{fragments/footer :: footerFragment}"></div> -->

<!-- Bootstrap JS (was in original, but not used by Tailwind, so keep only if needed elsewhere) -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->
</body>
</html>
