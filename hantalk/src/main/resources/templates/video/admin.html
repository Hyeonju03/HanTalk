<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 영상 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Tailwind CSS 메인 컬러 설정 (자료실 페이지 기준) */
        :root {
          --color-dark-navy: #2F4160;
          --color-coral-pink: #F29DA0;
          --color-soft-sky: #B5D0E3;
        }
        .bg-dark-navy { background-color: var(--color-dark-navy); }
        .text-dark-navy { color: var(--color-dark-navy); }
        .bg-coral-pink { background-color: var(--color-coral-pink); }
        .text-coral-pink { color: var(--color-coral-pink); }
        .bg-soft-sky { background-color: var(--color-soft-sky); }
        .text-soft-sky { color: var(--color-soft-sky); }

        .clickable-row {
          cursor: pointer;
        }

        .line-clamp-2 {
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }

        @media (max-width: 767px) {
            .search-form-flex-wrap {
                flex-wrap: wrap;
            }
        }

        /* 모든 페이지네이션 링크를 위한 기본 스타일 */
        .pagination-item-base {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem;
            background-color: transparent;
            color: #2F4160;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            text-decoration: none;
            font-weight: 600;
            min-width: 36px;
            height: 36px;
            box-sizing: border-box;
            transition-property: background-color, color, border-color;
            transition-duration: 200ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 모든 페이지네이션 링크의 호버 상태 */
        .pagination-item-base:hover {
            background-color: #e0e0e0;
            color: #2F4160;
            border-color: #e0e0e0;
        }

        /* 활성 페이지 번호 스타일 */
        .pagination-item-base.active {
            font-weight: bold;
            background-color: #4B4B4B;
            color: white;
            border-color: #4B4B4B;
        }

        /* 활성 페이지 버튼의 호버 효과 */
        .pagination-item-base.active:hover {
            background-color: #4B4B4B;
            color: white;
            border-color: #4B4B4B;
        }

        /* 비활성화된 버튼 스타일 */
        .pagination-item-base.disabled {
            opacity: 0.5;
            cursor: default !important;
            background-color: transparent;
            color: #2F4160;
            border-color: transparent;
        }

        /* 비활성화된 버튼의 호버 효과 */
        .pagination-item-base.disabled:hover {
            background-color: transparent;
            color: #2F4160;
            border-color: transparent;
        }
    </style>
</head>
<body class="bg-[#f3f4f6] text-[#2F4160] font-sans flex flex-col min-h-screen">

<!-- 헤더 프래그먼트 삽입 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>

<!-- 전체 페이지 컨테이너 -->
<div class="flex-grow flex justify-center w-full">
    <div class="flex-1 flex flex-col p-4 w-full max-w-7xl">

        <!-- 모든 내용을 담는 흰색 배경 컨테이너 -->
        <main class="bg-white rounded-xl shadow-xl mx-auto flex-grow w-full p-8 box-border">

            <!-- 관리자 페이지 제목 및 버튼 -->
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-dark-navy">관리자 영상 목록</h1>
                <a th:href="@{/admin}"
                   class="inline-block bg-[#2F4160] hover:bg-[#4B4B4B] text-white py-2 px-4 rounded-lg shadow-md transition-colors duration-200">
                    관리자 페이지 <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>

            <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0 mb-6">
                <!-- 새 영상 등록 버튼 -->
                <a th:href="@{/video/admin/chuga}"
                   class="bg-[#4B4B4B] text-white font-semibold py-2 px-6 rounded-lg hover:bg-[#2F4160] transition duration-300 shadow-md flex items-center">
                    <i class="fas fa-plus mr-2"></i>
                    새 영상 등록
                </a>

                <!-- 검색 폼 그룹 -->
                <form method="get" th:action="@{/video/admin/list}" id="searchForm" class="flex items-center space-x-2 search-form-flex-wrap">
                    <select name="searchType" id="searchType"
                            class="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#B5D0E3]">
                        <option value="title" th:selected="${searchType == 'title'}">제목</option>
                        <option value="content" th:selected="${searchType == 'content'}">내용</option>
                        <option value="filename" th:selected="${searchType == 'filename'}">파일명</option>
                        <option value="all" th:selected="${searchType == 'all'}">제목 + 내용 + 파일명</option>
                    </select>
                    <input type="text" name="keyword" placeholder="검색어를 입력해주세요" th:value="${keyword}" id="keyword"
                           class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#B5D0E3] min-w-40"/>
                    <button type="submit" class="bg-[#4B4B4B] text-white px-4 py-2 rounded-lg hover:bg-[#2F4160] transition-colors duration-200">
                        <i class="fas fa-search mr-1"></i> 검색
                    </button>
                    <button type="button" onclick="resetSearch()"
                            class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors duration-200">
                        <i class="fas fa-redo mr-1"></i> 초기화
                    </button>
                </form>
            </div>

            <!-- 검색 결과 없을 때 -->
            <div th:if="${#lists.isEmpty(videoPage.content)}" class="p-6 rounded-lg text-center text-gray-500">
        <span th:if="${not #strings.isEmpty(param.keyword)}">
          "<span th:text="${param.keyword}"></span>"에 대한 검색 결과가 없습니다.
        </span>
                <span th:unless="${not #strings.isEmpty(param.keyword)}">
          등록된 영상이 없습니다.
        </span>
            </div>

            <div th:if="${not #lists.isEmpty(videoPage.content)}" class="rounded-xl shadow-xl overflow-hidden">
                <!-- 헤더 (Flexbox) -->
                <div class="flex bg-gray-200 text-[#2F4160] rounded-t-xl font-semibold text-sm uppercase tracking-wider">
                    <div class="px-6 py-3 w-[6%] flex-none whitespace-nowrap text-center">번호</div>
                    <div class="px-6 py-3 flex-1 min-w-0 text-center">제목</div>
                    <div class="px-6 py-3 flex-1 min-w-0 text-center">설명</div>
                    <div class="px-6 py-3 flex-1 min-w-0 text-center">파일명</div>
                    <div class="px-6 py-3 w-[10%] flex-none text-center">등록일</div>
                    <div class="px-6 py-3 w-[10%] flex-none text-center">수정일</div>
                    <div class="px-6 py-3 w-48 flex-none text-center">관리</div>
                </div>

                <div class="bg-white divide-y divide-gray-200">
                    <div th:each="video, stat : ${videoPage.content}"
                         th:id="'row-' + ${video.videoId}"
                         th:data-id="${video.videoId}"
                         class="flex hover:bg-gray-50 transition-colors duration-150 clickable-row"
                         th:attr="onclick='window.location.href=\'/video/view/\' + ' + ${video.videoId}">
                        <div class="px-6 py-4 text-sm text-gray-900 whitespace-nowrap w-[6%] flex-none text-center" th:text="${videoPage.number * videoPage.size + stat.index + 1}">1</div>
                        <div class="px-6 py-4 text-sm font-medium text-gray-900 overflow-hidden flex-1 min-w-0 text-center" th:title="${video.title}">
                            <div th:text="${video.title}" class="w-full line-clamp-2">제목</div>
                        </div>
                        <div class="px-6 py-4 text-sm text-gray-900 overflow-hidden flex-1 min-w-0 text-center" th:title="${video.content}">
                            <div th:text="${video.content}" class="w-full line-clamp-2">설명</div>
                        </div>
                        <div class="px-6 py-4 text-sm text-gray-900 overflow-hidden flex-1 min-w-0 text-center" th:title="${video.videoName}">
                            <div th:text="${video.videoName}" class="w-full line-clamp-2">파일명</div>
                        </div>
                        <div class="px-6 py-4 text-sm text-gray-900 whitespace-nowrap w-[10%] flex-none text-center" th:text="${#temporals.format(video.createDate, 'yyyy-MM-dd')}">등록일</div>
                        <div class="px-6 py-4 text-sm text-gray-900 whitespace-nowrap w-[10%] flex-none text-center" th:text="${video.updateDate != null ? #temporals.format(video.updateDate, 'yyyy-MM-dd') : ''}">수정일</div>
                        <div class="px-6 py-4 text-sm font-medium whitespace-nowrap w-48 flex-none text-center" onclick="event.stopPropagation()">
                            <div class="flex space-x-1 justify-center">
                                <a th:href="@{/video/admin/sujung/{id}(id=${video.videoId}, page=${videoPage.number}, searchType=${searchType}, keyword=${keyword})}"
                                   class="bg-[#4B4B4B] text-white px-3 py-1 rounded-lg hover:bg-[#2F4160] transition-all duration-300 flex items-center"
                                   title="수정">
                                    <i class="fas fa-edit mr-1"></i> 수정
                                </a>
                                <button type="button"
                                        th:attr="onclick='deleteVideo(' + ${video.videoId} + ', ' + ${videoPage.number} + ', ' + ${videoPage.content.size()} + ')'"
                                        class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-all duration-300 flex items-center"
                                        title="삭제">
                                    <i class="fas fa-trash-alt mr-1"></i> 삭제
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 페이지네이션 컨트롤 -->
            <div class="pagination flex justify-center items-center mt-6 space-x-2" th:if="${videoPage.totalPages > 1}">
                <a th:href="@{|/video/admin/list?page=0&searchType=${searchType}&keyword=${keyword}|}"
                   th:classappend="${!videoPage.hasPrevious()} ? 'disabled'"
                   class="pagination-item-base">처음</a>
                <a th:href="@{|/video/admin/list?page=${videoPage.number - 1}&searchType=${searchType}&keyword=${keyword}|}"
                   th:classappend="${!videoPage.hasPrevious()} ? 'disabled'"
                   class="pagination-item-base">이전</a>

                <span th:each="i : ${#numbers.sequence(0, videoPage.totalPages - 1)}">
          <a th:href="@{|/video/admin/list?page=${i}&searchType=${searchType}&keyword=${keyword}|}"
             th:classappend="${i == videoPage.number} ? 'active'"
             class="pagination-item-base" th:text="${i + 1}">1</a>
        </span>

                <a th:href="@{|/video/admin/list?page=${videoPage.number + 1}&searchType=${searchType}&keyword=${keyword}|}"
                   th:classappend="${!videoPage.hasNext()} ? 'disabled'"
                   class="pagination-item-base">다음</a>
                <a th:href="@{|/video/admin/list?page=${videoPage.totalPages - 1}&searchType=${searchType}&keyword=${keyword}|}"
                   th:classappend="${!videoPage.hasNext()} ? 'disabled'"
                   class="pagination-item-base">마지막</a>
            </div>

        </main>
    </div>
</div>

<script>
    // 검색 폼 초기화
    function resetSearch() {
        document.getElementById('searchType').value = 'title';
        document.getElementById('keyword').value = '';
        document.getElementById('searchForm').submit();
    }

   function deleteVideo(videoId, currentPage, currentSize) {
        if (!confirm("정말로 이 영상을 삭제하시겠습니까?")) return;

        fetch("/video/admin/" + videoId, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        })
        .then(res => {
            if (!res.ok) throw new Error("삭제 실패");
            return res.text();
        })
        .then(msg => {
            const newSize = currentSize - 1;
            let targetPage = currentPage;

            if (newSize === 0 && currentPage > 0) {
                targetPage = currentPage - 1;
            }

            // 검색 조건과 함께 새로운 페이지로 이동
            const searchType = document.getElementById('searchType').value;
            const keyword = document.getElementById('keyword').value;
            window.location.href = `/video/admin/list?page=${targetPage}&searchType=${searchType}&keyword=${keyword}`;
        })
        .catch(err => {
            alert(err);
            console.error(err);
        });
    }
</script>

<div th:replace="~{fragments/footer :: footerFragment}"></div>

</body>
</html>
