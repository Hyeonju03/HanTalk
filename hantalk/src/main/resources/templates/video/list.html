<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영상 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
            color: #2F4160;
        }

        .video-card {
            transition: all 0.3s ease;
            border-radius: 1rem;
            border: 1px solid rgba(181, 208, 227, 0.3);
            background-color: #ffffff;
        }

        .video-card:hover {
            border-color: #2F4160;
            transform: scale(1.03);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.1);
        }

        .upgraded-btn {
            color: #2F4160;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }

        .upgraded-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .all-videos-btn-hover:hover {
            background-color: #2F4160;
            color: #ffffff;
        }

        .favorite-btn-hover:hover {
            background-color: #F29DA0;
            color: #ffffff;
        }

        .play-icon-overlay {
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .thumbnail-link:hover .play-icon-overlay {
            background-color: rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
        }
        .play-icon-svg {
            width: 3.5rem;
            height: 3.5rem;
            fill: currentColor;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
        }

        .video-section {
            background-color: rgba(181, 208, 227, 0.1);
            padding: 3rem 1.5rem;
            border-radius: 1.5rem;
            border: 1px solid rgba(181, 208, 227, 0.3);
        }

        .clamp-2-lines {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-[#f3f4f6] font-sans antialiased min-h-screen flex flex-col">

<div th:replace="~{fragments/header :: headerFragment}"></div>

<div class="max-w-7xl w-full mx-auto bg-white p-8 rounded-xl shadow-lg mt-8">
    <h1 class="text-3xl font-bold text-[#2F4160] mb-6 text-center">
        <span th:if="${isFavorite}">찜한 영상 목록</span>
        <span th:unless="${isFavorite}">영상 목록</span>
    </h1>

    <div class="max-w-screen-xl mx-auto mb-8 flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex flex-wrap gap-2 justify-center">
            <a href="/video/list" class="px-6 py-2 bg-white text-gray-800 font-semibold rounded-lg all-videos-btn-hover transition duration-300 upgraded-btn">
                전체 영상
            </a>
            <a href="/video/list?isFavorite=true" class="px-6 py-2 bg-white text-gray-800 font-semibold rounded-lg favorite-btn-hover transition duration-300 upgraded-btn">
                찜한 영상
            </a>
        </div>

        <form th:unless="${isFavorite}" method="get" th:action="@{/video/list}" class="flex flex-wrap gap-2 w-full md:w-auto">
            <select name="searchType" class="flex-shrink p-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-main-dark bg-white text-gray-800">
                <option value="title" th:selected="${searchType == 'title'}" class="bg-white text-gray-800">제목</option>
                <option value="content" th:selected="${searchType == 'content'}" class="bg-white text-gray-800">내용</option>
                <option value="all" th:selected="${searchType == 'all'}" class="bg-white text-gray-800">제목 + 내용</option>
            </select>
            <input type="text" name="keyword" th:value="${keyword}" placeholder="검색어 입력"
                   class="flex-grow min-w-0 p-2 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-main-dark text-gray-800" />

            <button type="submit"
                    class="bg-[#B5D0E3] hover:bg-[#8DAAC1] text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                검색
            </button>
        </form>
    </div>

    <div class="video-list-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">
        <a th:each="video, stat : ${videoPage.content}"
           href="#"
           class="video-card relative p-4 flex flex-col cursor-pointer card-link"
           th:data-video-id="${video.videoId}"
           th:data-is-admin="${isAdmin}"
           th:data-is-favorite="${isFavorite}">

            <div class="thumbnail-link relative block w-full aspect-video overflow-hidden rounded-lg mb-3">
                <video class="video-thumbnail w-full h-full object-cover pointer-events-none"
                       muted playsinline
                       preload="metadata">
                    <source th:src="@{'/videos/' + ${video.videoName}}" type="video/mp4" />
                    영상 태그를 지원하지 않는 브라우저입니다.
                </video>
                <div class="play-icon-overlay absolute inset-0 flex items-center justify-center text-white pointer-events-none">
                    <svg class="play-icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M5.25 5.653c0-.856.917-1.341 1.697-.969l10.992 5.653a1.5 1.5 0 010 2.7l-10.992 5.653c-.78.372-1.697-.113-1.697-.969V5.653z" />
                    </svg>
                </div>
            </div>

            <div class="flex items-start justify-between">
                <div class="flex-grow min-w-0">
                    <strong class="video-title text-xl font-bold text-gray-900 leading-tight mb-1">
                        <span th:text="${video.title}" class="no-underline text-[#2F4160] transition duration-300 clamp-2-lines">영상 제목</span>
                    </strong>
                    <div class="views-placeholder text-base font-bold text-gray-700 mt-1">
                        조회수 <span th:text="${video.viewHit}" th:id="'viewHit-' + ${video.videoId}">0</span>
                    </div>
                </div>

                <button class="favorite-btn text-2xl cursor-pointer z-20 ml-2"
                        th:data-video-id="${video.videoId}"
                        onclick="event.preventDefault(); event.stopPropagation(); toggleFavorite(event, this.dataset.videoId);">
                    <svg class="heart-empty w-6 h-6 fill-current text-gray-400" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <svg class="heart-filled w-6 h-6 fill-current text-red-500 hidden" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </button>
            </div>
        </a>
    </div>

    <div th:if="${videoPage.totalElements == 0}" class="text-center p-12 bg-white rounded-xl shadow-inner no-results">
        <p class="text-xl font-medium text-[#2F4160]">
            <span th:if="${isFavorite}">찜한 영상이 없습니다.</span>
            <span th:unless="${isFavorite}">검색 결과가 없습니다.</span>
        </p>
    </div>

    <div class="pagination flex justify-center items-center mt-8 space-x-2" th:if="${videoPage.totalPages > 1}">
        <a th:if="${videoPage.hasPrevious()}"
           th:href="@{|/video/list?page=${videoPage.number - 1}&isFavorite=${isFavorite}|}"
           class="inline-flex items-center justify-center px-3 py-1.5 bg-white text-[#2F4160] no-underline rounded-md border border-gray-300 hover:bg-[#f3f4f6] hover:text-[#2F4160] transition-colors duration-200">이전</a>

        <a th:each="i : ${#numbers.sequence(0, videoPage.totalPages - 1)}"
           th:href="@{|/video/list?page=${i}${isFavorite ? '&isFavorite=true' : ''}${isFavorite ? '' : '&keyword=' + keyword + '&searchType=' + searchType}|}"
           th:text="${i + 1}"
           th:classappend="${i == videoPage.number} ? 'bg-[#B5D0E3] text-white font-bold' : 'bg-white text-[#2F4160] border border-gray-300'"
           class="block w-8 h-8 flex items-center justify-center rounded-md no-underline transition-colors duration-200 hover:bg-[#f3f4f6] hover:text-[#2F4160]"></a>

        <a th:if="${videoPage.hasNext()}"
           th:href="@{|/video/list?page=${videoPage.number + 1}&isFavorite=${isFavorite}|}"
           class="inline-flex items-center justify-center px-3 py-1.5 bg-white text-[#2F4160] no-underline rounded-md border border-gray-300 hover:bg-[#f3f4f6] hover:text-[#2F4160] transition-colors duration-200">다음</a>
    </div>
</div>

<div id="message-box" class="fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg text-white font-bold hidden opacity-0 transition-opacity duration-300 z-[60]"></div>

<div th:replace="~{fragments/footer :: footerFragment}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const loggedInUserNo = [[${userId}]];
    const isFavoritePage = [[${isFavorite}]];

    // 메시지 숨기기 타이머 ID를 저장할 변수
    let messageTimeout;

    // 메시지 알림창을 표시하는 함수
    function showMessage(message, type = 'success') {
        // 기존 타이머가 있다면 취소
        clearTimeout(messageTimeout);

        const msgBox = document.getElementById('message-box');
        msgBox.textContent = message;
        msgBox.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-lg font-bold text-white z-[60]'; // text-white 추가
        msgBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-700', 'hidden');

        if (type === 'success') {
            msgBox.classList.add('bg-green-500');
        } else if (type === 'info') {
            msgBox.classList.add('bg-gray-700');
        } else {
            msgBox.classList.add('bg-red-500');
        }

        setTimeout(() => {
            msgBox.style.opacity = '1';
        }, 10); // Transition start

        // 메시지 숨기기 타이머 설정
        messageTimeout = setTimeout(() => {
            msgBox.style.opacity = '0';
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 300); // fade out animation time
        }, 3500);
    }

    // 찜하기 상태를 토글하는 함수
    async function toggleFavorite(event, videoId) {
        const btn = event.currentTarget;
        const heartEmpty = btn.querySelector('.heart-empty');
        const heartFilled = btn.querySelector('.heart-filled');
        const isCurrentlyFavorite = !heartFilled.classList.contains('hidden');

        if (isCurrentlyFavorite) {
            // 현재 찜한 상태 -> 찜 취소
            heartEmpty.classList.remove('hidden');
            heartFilled.classList.add('hidden');
        } else {
            // 현재 찜하지 않은 상태 -> 찜하기
            heartEmpty.classList.add('hidden');
            heartFilled.classList.remove('hidden');
        }

        const url = '/video/favorite';
        const method = isCurrentlyFavorite ? 'DELETE' : 'POST';
        const payload = { userId: loggedInUserNo, videoId: videoId };

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // 오류 발생 시 UI 롤백
                if (isCurrentlyFavorite) {
                    // 찜 취소 실패 -> 다시 채워진 하트로
                    heartEmpty.classList.add('hidden');
                    heartFilled.classList.remove('hidden');
                } else {
                    // 찜하기 실패 -> 다시 빈 하트로
                    heartEmpty.classList.remove('hidden');
                    heartFilled.classList.add('hidden');
                }
                showMessage('⚠️ 찜 상태 변경 실패! 서버 오류를 확인해주세요.', 'error');
            } else {
                const action = isCurrentlyFavorite ? '찜 취소' : '찜하기';
                const messageType = isCurrentlyFavorite ? 'info' : 'success';
                showMessage(`✅ ${action}가 완료되었습니다!`, messageType);

                if (isFavoritePage && isCurrentlyFavorite) {
                    const cardToRemove = btn.closest('.video-card');
                    if (cardToRemove) {
                        cardToRemove.remove();
                    }
                }
            }
        } catch (error) {
            console.error('Error toggling favorite:', error);
            // 네트워크 오류 시 UI 롤백
            if (isCurrentlyFavorite) {
                heartEmpty.classList.add('hidden');
                heartFilled.classList.remove('hidden');
            } else {
                heartEmpty.classList.remove('hidden');
                heartFilled.classList.add('hidden');
            }
            showMessage('⚠️ 네트워크 오류 발생! 연결 상태를 확인해주세요.', 'error');
        }
    }

    async function updateFavoriteIcons() {
        if (!loggedInUserNo) {
            return;
        }

        const videoCards = document.querySelectorAll('.video-card');

        if (isFavoritePage) {
            videoCards.forEach(card => {
                const heartBtn = card.querySelector('.favorite-btn');
                if (heartBtn) {
                    const heartEmpty = heartBtn.querySelector('.heart-empty');
                    const heartFilled = heartBtn.querySelector('.heart-filled');
                    heartEmpty.classList.add('hidden');
                    heartFilled.classList.remove('hidden');
                }
            });
            return;
        }

        for (const card of videoCards) {
            const videoId = card.dataset.videoId;
            try {
                const response = await fetch(`/video/favorite/check/${videoId}`);
                if (response.ok) {
                    const isFavorite = await response.json();
                    const heartBtn = card.querySelector('.favorite-btn');
                    if (heartBtn) {
                        const heartEmpty = heartBtn.querySelector('.heart-empty');
                        const heartFilled = heartBtn.querySelector('.heart-filled');
                        heartEmpty.classList.toggle('hidden', isFavorite);
                        heartFilled.classList.toggle('hidden', !isFavorite);
                    }
                }
            } catch (error) {
                console.error(`Error checking favorite status for video ${videoId}:`, error);
            }
        }
    }

    function setThumbnailTime() {
        document.querySelectorAll('.video-card video').forEach(video => {
            const thumbnailTime = 2;
            video.addEventListener('loadeddata', () => {
                video.currentTime = thumbnailTime;
            }, { once: true });
        });
    }

    // 비디오 카드에 마우스를 올렸을 때 동영상 재생 로직
    function setupVideoCardEvents() {
        document.querySelectorAll('.video-card').forEach(card => {
            const video = card.querySelector('video');
            if (video) {
                card.addEventListener('mouseenter', () => {
                    video.play();
                });
                card.addEventListener('mouseleave', () => {
                    video.pause();
                    video.currentTime = 2;
                });
            }
        });
    }

    function setupCardLinkEvents() {
        document.querySelectorAll('.card-link').forEach(link => {
            link.addEventListener('click', async (event) => {
                event.preventDefault(); // 기본 링크 이동 동작 방지

                const videoId = event.currentTarget.getAttribute('data-video-id');
                const isAdmin = event.currentTarget.getAttribute('data-is-admin') === 'true';
                const isFavorite = event.currentTarget.getAttribute('data-is-favorite') === 'true';
                const viewHitSpan = document.getElementById('viewHit-' + videoId);

                try {
                    const response = await fetch('/video/increment-view/' + videoId, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (viewHitSpan) {
                            viewHitSpan.textContent = data.viewHit;
                        }
                    } else {
                        console.error('Failed to increment view count.');
                    }
                } catch (error) {
                    console.error('Error during view count update:', error);
                } finally {
                    let redirectUrl;
                    if (isFavorite) {
                        redirectUrl = '/video/contentView/' + videoId;
                    } else if (isAdmin) {
                        redirectUrl = '/video/view/' + videoId;
                    } else {
                        redirectUrl = '/video/view/' + videoId;
                    }
                    window.location.href = redirectUrl;
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        setThumbnailTime();
        setupVideoCardEvents();
        updateFavoriteIcons();
        setupCardLinkEvents();
    });

    window.toggleFavorite = toggleFavorite;
    /*]]>*/
</script>
</body>
</html>
